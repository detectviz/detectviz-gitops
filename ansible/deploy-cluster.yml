---
# ==============================================================================
# Detectviz Platform - Ansible ä¸»éƒ¨ç½²åŠ‡æœ¬ (Main Playbook)
#
# åŸ·è¡Œé †åºï¼š
# 1.  **å‰ç½®æº–å‚™ (Pre-flight)**: ç¢ºä¿ `yq` å·¥å…·å·²å®‰è£ã€‚
# 2.  **ç¯€é»åˆå§‹åŒ– (Common)**: åœ¨æ‰€æœ‰ç¯€é»ä¸ŠåŸ·è¡Œç³»çµ±æ›´æ–°ã€å®‰è£å¿…è¦å¥—ä»¶ã€‚
# 3.  **ç¶²è·¯é…ç½® (Network)**: è¨­å®šé›™ç¶²è·¯ä»‹é¢ã€MTU åŠ hostsã€‚
# 4.  **Master ç¯€é»éƒ¨ç½² (Master)**: åˆå§‹åŒ– Kubernetes æ§åˆ¶å¹³é¢ã€å®‰è£ CNIã€‚
# 5.  **Worker ç¯€é»éƒ¨ç½² (Worker)**: å°‡å·¥ä½œç¯€é»åŠ å…¥é›†ç¾¤ã€‚
# 6.  **ç¯€é»æ¨™ç±¤ (Node Labels)**: ç‚ºç‰¹å®šç¯€é»æ·»åŠ æ¨™ç±¤ï¼Œç”¨æ–¼å·¥ä½œè² è¼‰èª¿åº¦ã€‚
# 7.  **ArgoCD éƒ¨ç½² (ArgoCD)**: å®‰è£ä¸¦è¨­å®š ArgoCD GitOps å¼•æ“ã€‚
# 8.  **æœ€çµ‚é©—è­‰ (Validation)**: æª¢æŸ¥é›†ç¾¤ç‹€æ…‹ä¸¦é¡¯ç¤ºéƒ¨ç½²æ‘˜è¦ã€‚
#
# ==============================================================================

- name: "[Pre-flight] Ensure yq is installed on the control machine"
  hosts: localhost
  connection: local
  become: true
  gather_facts: false
  tasks:
    - name: "Install yq"
      ansible.builtin.apt:
        name: yq
        state: present
        update_cache: yes

- name: "[Phase 1] Prepare all nodes for Kubernetes installation (ç¯€é»åˆå§‹åŒ–)"
  hosts: k8s_cluster
  become: true
  gather_facts: true
  roles:
    - role: common

- name: "[Phase 2] Configure Multi-Network Architecture (ç¶²è·¯é…ç½®)"
  hosts: k8s_cluster
  become: true
  gather_facts: false
  roles:
    - role: network

- name: "[Phase 3] Initialize and join control plane nodes (Master ç¯€é»éƒ¨ç½²)"
  hosts: masters
  become: true
  gather_facts: true
  serial: 1
  roles:
    - role: master

- name: "[Phase 4] Join worker nodes to the cluster (Worker ç¯€é»éƒ¨ç½²)"
  hosts: workers
  become: true
  gather_facts: true
  roles:
    - role: worker

- name: "[Phase 5] Apply Node Labels (ç¯€é»æ¨™ç±¤)"
  hosts: masters[0]
  become: false
  gather_facts: false
  tasks:
    - name: "Label nodes for specific workloads (ç‚ºç¯€é»æ·»åŠ æ¨™ç±¤)"
      ansible.builtin.command: >
        kubectl label node {{ item.name }} {{ item.label }} --overwrite
      loop:
        - { name: "master-1", label: "node-role.kubernetes.io/workload-monitoring=true" }
        - { name: "master-2", label: "node-role.kubernetes.io/workload-mimir=true" }
        - { name: "master-3", label: "node-role.kubernetes.io/workload-loki=true" }
        - { name: "app-worker", label: "node-role.kubernetes.io/workload-apps=true" }
      changed_when: true
      ignore_errors: true

- name: "[Phase 6] Install ArgoCD and Bootstrap GitOps (ArgoCD éƒ¨ç½²)"
  hosts: masters[0]
  become: false
  gather_facts: false
  vars:
    argocd_install_manifest: "https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml"
    argocd_node_selector:
      node-role.kubernetes.io/workload-apps: "true"
  tasks:
    - name: "Ensure ArgoCD namespace exists (ç¢ºä¿ ArgoCD å‘½åç©ºé–“å­˜åœ¨)"
      kubernetes.core.k8s:
        name: argocd
        api_version: v1
        kind: Namespace
        state: present

    - name: "Download ArgoCD install manifest (ä¸‹è¼‰ ArgoCD å®‰è£æ¸…å–®)"
      ansible.builtin.get_url:
        url: "{{ argocd_install_manifest }}"
        dest: "/tmp/argocd-install.yaml"
        mode: "0644"

    - name: "Add nodeSelector to ArgoCD components (ç‚º ArgoCD çµ„ä»¶æ·»åŠ  nodeSelector)"
      ansible.builtin.shell: |
        yq eval 'select(.kind == "{{ item.kind }}" and .metadata.name == "{{ item.name }}").spec.template.spec.nodeSelector = {{ argocd_node_selector | to_json }}' -i "/tmp/argocd-install.yaml"
      args:
        executable: /bin/bash
      loop:
        - { kind: "Deployment", name: "argocd-repo-server" }
        - { kind: "Deployment", name: "argocd-applicationset-controller" }
        - { kind: "Deployment", name: "argocd-dex-server" }
        - { kind: "Deployment", name: "argocd-server" }
        - { kind: "StatefulSet", name: "argocd-application-controller" }

    - name: "Apply ArgoCD install manifest (æ‡‰ç”¨ ArgoCD å®‰è£æ¸…å–®)"
      kubernetes.core.k8s:
        state: present
        src: "/tmp/argocd-install.yaml"
        namespace: argocd
        wait: yes
        timeout: 300

    - name: "Bootstrap ArgoCD Root Application (å•Ÿå‹• ArgoCD æ ¹æ‡‰ç”¨ç¨‹å¼)"
      kubernetes.core.k8s:
        state: present
        src: "{{ playbook_dir }}/../argocd/root-argocd-app.yaml"
        namespace: argocd

- name: "[Phase 7] Validate Kubernetes Cluster Deployment (æœ€çµ‚é©—è­‰)"
  hosts: masters[0]
  become: false
  gather_facts: false
  tasks:
    - name: "Wait for all nodes to be in Ready state (ç­‰å¾…æ‰€æœ‰ç¯€é»é€²å…¥ Ready ç‹€æ…‹)"
      ansible.builtin.command: kubectl wait --for=condition=Ready node --all --timeout=5m
      changed_when: false

    - name: "Get final cluster node status (ç²å–æœ€çµ‚é›†ç¾¤ç¯€é»ç‹€æ…‹)"
      ansible.builtin.command: kubectl get nodes -o wide
      register: cluster_status
      changed_when: false

    - name: "Display deployment completion summary (é¡¯ç¤ºéƒ¨ç½²æ‘˜è¦)"
      ansible.builtin.debug:
        msg: |
          ======================================================================
          ğŸ‰ DetectViz Kubernetes Cluster Deployment Completed Successfully! ğŸ‰
          ======================================================================

          Kubernetes Version: {{ kubernetes_version }}
          Cluster Nodes:
          {{ cluster_status.stdout }}

          Access Points:
          â€¢ Kubernetes API: https://{{ control_plane_vip }}:6443
          â€¢ ArgoCD UI:      https://argocd.{{ domain }}
          â€¢ Grafana:        https://grafana.{{ domain }}

          Next Steps:
          1.  **Vault Initialization**: Manually unseal Vault instances.
          2.  **ArgoCD Sync**: Log in to ArgoCD UI and sync the applications.
          3.  **Verify Workloads**: Check if all application pods are running correctly.

          ======================================================================
