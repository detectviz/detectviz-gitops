---
- name: Prepare all nodes for Kubernetes installation
  hosts: k8s_cluster
  become: true
  gather_facts: true
  roles:
    - role: common

- name: Initialize and join control plane nodes
  hosts: masters
  become: true
  gather_facts: true
  serial: 1
  roles:
    - role: master

- name: Join worker nodes to the cluster
  hosts: workers
  become: true
  gather_facts: true
  roles:
    - role: worker

- name: "[P2.5] Apply workload labels to nodes"
  hosts: masters[0]
  become: false
  gather_facts: false
  tasks:
    - name: Label master-1 for Prometheus
      ansible.builtin.command: >
        kubectl label node master-1
        node-role.kubernetes.io/workload-monitoring=true
        --overwrite
      changed_when: true

    - name: Label master-2 for Mimir
      ansible.builtin.command: >
        kubectl label node master-2
        node-role.kubernetes.io/workload-mimir=true
        --overwrite
      changed_when: true

    - name: Label master-3 for Loki
      ansible.builtin.command: >
        kubectl label node master-3
        node-role.kubernetes.io/workload-loki=true
        --overwrite
      changed_when: true

    - name: Label app-worker for Applications
      ansible.builtin.command: >
        kubectl label node app-worker
        node-role.kubernetes.io/workload-apps=true
        --overwrite
      changed_when: true

- name: "[P2.5] Inject initial GitOps credentials for ArgoCD"
  hosts: masters[0]
  become: false
  gather_facts: false
  vars:
    gitops_ssh_key_path: "secrets/id_gitops"
  tasks:
    - name: Á¢∫‰øù ArgoCD ÂëΩÂêçÁ©∫ÈñìÂ≠òÂú®
      kubernetes.core.k8s:
        name: argocd
        api_version: v1
        kind: Namespace
        state: present

    - name: Âª∫Á´ã ArgoCD SSH Secret
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: argocd-ssh-creds
            namespace: argocd
            labels:
              argocd.argoproj.io/secret-type: repository
          type: Opaque
          data:
            sshPrivateKey: "{{ lookup('file', gitops_ssh_key_path) | b64encode }}"
            url: "git@github.com:detectviz/detectviz-gitops.git"

- name: "[P3] Bootstrap ArgoCD (GitOps Engine)"
  hosts: masters[0]
  become: false
  gather_facts: false
  vars:
    argocd_install_manifest: "https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml"
    argocd_node_selector:
      node-role.kubernetes.io/workload-apps: "true"
  tasks:
    - name: Download ArgoCD install manifest
      ansible.builtin.get_url:
        url: "{{ argocd_install_manifest }}"
        dest: "/tmp/argocd-install.yaml"
        mode: '0644'

    - name: Add nodeSelector to ArgoCD core components
      community.general.yedit:
        src: "/tmp/argocd-install.yaml"
        key: "spec.template.spec.nodeSelector"
        value: "{{ argocd_node_selector }}"
        kind: "{{ item.kind }}"
        name: "{{ item.name }}"
      loop:
        - { kind: 'Deployment', name: 'argocd-repo-server' }
        - { kind: 'Deployment', name: 'argocd-applicationset-controller' }
        - { kind: 'Deployment', name: 'argocd-dex-server' }
        - { kind: 'Deployment', name: 'argocd-server' }
        - { kind: 'StatefulSet', name: 'argocd-application-controller' }

    - name: Apply ArgoCD install manifest
      kubernetes.core.k8s:
        state: present
        src: "/tmp/argocd-install.yaml"
        namespace: argocd
        wait: yes
        timeout: 300

    - name: "[P3] Deploy Root Application (App-of-Apps)"
      kubernetes.core.k8s:
        state: present
        src: "{{ playbook_dir }}/../argocd/root-argocd-app.yaml"
        namespace: argocd

- name: Validate Kubernetes Cluster Deployment
  hosts: masters[0]
  become: false
  gather_facts: false
  tasks:
    - name: Wait for all nodes to be in Ready state
      ansible.builtin.command: kubectl wait --for=condition=Ready node --all --timeout=5m
      changed_when: false

    - name: Get final cluster node status
      ansible.builtin.command: kubectl get nodes -o wide
      register: cluster_status
      changed_when: false

    - name: Display cluster deployment completion message
      ansible.builtin.debug:
        msg: |
          üéâ Detectviz Kubernetes Cluster Deployment Completed! üéâ

          Installed Components:
          ‚úÖ Kubernetes Cluster ({{ (cluster_status.stdout_lines | length) - 1 }} nodes)
          ‚úÖ Calico CNI Networking
          ‚úÖ Kube-VIP for Control Plane HA
          ‚úÖ ArgoCD GitOps Engine (Bootstrapped)

          Cluster Status:
          {{ cluster_status.stdout }}

          Next Steps:
          1. Verify Vault manual unseal and setup process.
          2. Manually sync P5 applications in ArgoCD UI.
          3. Monitor GitOps sync status: `argocd app list`
