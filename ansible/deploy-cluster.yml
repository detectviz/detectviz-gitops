---
# -----------------------------------------------------------------
# Play 1: æº–å‚™ Proxmox Host (è¨­å®š rp_filter)
# -----------------------------------------------------------------
- name: Prepare Proxmox Hypervisor
  hosts: pve_hosts
  become: true # ç¢ºä¿æœ‰ root æ¬Šé™
  roles:
    - proxmox-host # åŸ·è¡Œæˆ‘å€‘å‰›æ‰å»ºç«‹çš„ PVE Host ä¿®æ­£
# -----------------------------------------------------------------
# Play 2: éƒ¨ç½² Kubernetes å¢é›† (ä½ ç¾æœ‰çš„é‚è¼¯)
# -----------------------------------------------------------------

# ç¬¬ä¸€éšæ®µï¼šé…ç½® DNS å’Œç¶²è·¯
- name: é…ç½®æ‰€æœ‰ç¯€é»çš„ DNS å’Œç¶²è·¯è¨­å®š
  # é‡å°æ‰€æœ‰ç¯€é»åŸ·è¡Œ DNS å’Œç¶²è·¯é…ç½®
  hosts: all
  become: true # ä»¥ root æ¬Šé™åŸ·è¡Œæ‰€æœ‰ä»»å‹™
  gather_facts: true # æ”¶é›†ç³»çµ±äº‹å¯¦è³‡è¨Š
  vars:
    ansible_ssh_common_args: "-o StrictHostKeyChecking=no" # SSH é€£æ¥åƒæ•¸ï¼Œè·³éä¸»æ©Ÿé‡‘é‘°æª¢æŸ¥

  # ä»»å‹™åˆ—è¡¨
  tasks:
    # ä»»å‹™ï¼šç¢ºä¿ /etc/hosts æ–‡ä»¶åŒ…å« Detectviz é›†ç¾¤ä¸»æ©Ÿè§£æ
    - name: ç¢ºä¿ /etc/hosts åŒ…å« Detectviz é›†ç¾¤ä¸»æ©Ÿè§£æè¨˜éŒ„
      ansible.builtin.blockinfile:
        path: /etc/hosts # ç›®æ¨™æ–‡ä»¶è·¯å¾‘
        block: "{{ detectviz_hosts_block }}" # è¦æ’å…¥çš„å…§å®¹å€å¡Š
        marker: "# {mark} ANSIBLE MANAGED BLOCK - Detectviz Cluster Hosts" # æ¨™è¨˜ç¬¦ï¼Œç”¨æ–¼è­˜åˆ¥å’Œç®¡ç†
        state: present # ç¢ºä¿å€å¡Šå­˜åœ¨
      tags:
        - dns # DNS ç›¸é—œæ¨™ç±¤
        - hostsfile # ä¸»æ©Ÿæ–‡ä»¶æ¨™ç±¤

    # ä»»å‹™ï¼šé…ç½®å…§éƒ¨ DNS è§£æå™¨
    - name: é…ç½®å…§éƒ¨ DNS è§£æå™¨è¨­å®š
      ansible.builtin.copy:
        dest: /etc/resolv.conf # ç›®æ¨™æ–‡ä»¶è·¯å¾‘
        content: |
          nameserver 192.168.0.2
          search detectviz.internal
      tags:
        - dns # DNS ç›¸é—œæ¨™ç±¤
        - resolver # è§£æå™¨æ¨™ç±¤

# ç¬¬äºŒéšæ®µï¼šæº–å‚™æ‰€æœ‰ç¯€é»ä»¥å®‰è£ Kubernetes
- name: æº–å‚™æ‰€æœ‰ç¯€é»å®‰è£ Kubernetes ç’°å¢ƒ
  # é‡å°æ‰€æœ‰ç¯€é»æº–å‚™ Kubernetes é‹è¡Œç’°å¢ƒ
  hosts: all
  become: true # ä»¥ root æ¬Šé™åŸ·è¡Œ
  gather_facts: true # æ”¶é›†ç³»çµ±è³‡è¨Š

  # é ä»»å‹™ï¼šåœ¨æ‡‰ç”¨è§’è‰²ä¹‹å‰åŸ·è¡Œ
  pre_tasks:
    # ä»»å‹™ï¼šæª¢æŸ¥é›†ç¾¤ç‹€æ…‹ä¸¦æ±ºå®šæ˜¯å¦éœ€è¦æ¸…ç†
    - name: æª¢æŸ¥é›†ç¾¤ç‹€æ…‹ï¼ˆæ±ºå®šæ˜¯å¦éœ€è¦æ¸…ç† Kubernetes è³‡æºï¼‰
      ansible.builtin.stat:
        path: /etc/kubernetes/admin.conf
      register: kubeconfig_stat
      when: reset_cluster | bool

    # ä»»å‹™ï¼šæ¸…ç†é›†ç¾¤ç´šåˆ¥è³‡æºï¼ˆStorageClass, PV, PVCï¼‰- åƒ…åœ¨é›†ç¾¤é‹è¡Œæ™‚åŸ·è¡Œ
    - name: æ¸…ç†é›†ç¾¤ç´šåˆ¥çš„ Kubernetes è³‡æºï¼ˆé‡ç½®å‰ï¼‰
      ansible.builtin.command: "{{ item }}"
      loop:
        - kubectl delete storageclass --all --ignore-not-found=true --timeout=60s # åˆªé™¤æ‰€æœ‰ StorageClass
        - kubectl delete pv --all --ignore-not-found=true --timeout=60s # åˆªé™¤æ‰€æœ‰ PersistentVolume
        - kubectl delete pvc --all --all-namespaces --ignore-not-found=true --timeout=60s # åˆªé™¤æ‰€æœ‰ PersistentVolumeClaim
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf # ä½¿ç”¨ç¾æœ‰çš„ admin.conf
      when:
        - reset_cluster | bool
        - kubeconfig_stat.stat.exists | bool # åªæœ‰åœ¨ kubeconfig å­˜åœ¨æ™‚æ‰åŸ·è¡Œ
        - inventory_hostname == groups['masters'][0] # åªåœ¨ç¬¬ä¸€å€‹ master ç¯€é»åŸ·è¡Œ
      ignore_errors: true # å¦‚æœé›†ç¾¤ä¸å¯ç”¨ï¼Œå¿½ç•¥éŒ¯èª¤ç¹¼çºŒåŸ·è¡Œ
      tags:
        - reset

    # ä»»å‹™ï¼šæª¢æŸ¥ä¸¦åœæ­¢ kubelet å’Œ containerd æœå‹™ï¼ˆæº–å‚™é‡ç½®ï¼‰
    - name: åœæ­¢ kubelet å’Œ containerd æœå‹™ï¼ˆæº–å‚™é‡ç½®ï¼‰
      ansible.builtin.systemd:
        name: "{{ item }}"
        state: stopped
        daemon_reload: true
      loop:
        - kubelet
        - containerd
      when: reset_cluster | bool
      failed_when: false # æœå‹™ä¸å­˜åœ¨æ™‚ä¸è¦–ç‚ºå¤±æ•—
      tags:
        - reset

    # ä»»å‹™ï¼šåˆªé™¤éœæ…‹ Pod manifestsï¼ˆåƒ…åœ¨ master ç¯€é»ï¼‰
    - name: åˆªé™¤ Master ç¯€é»ä¸Šçš„éœæ…‹ Pod è¨­å®šæª”
      ansible.builtin.file:
        path: "/etc/kubernetes/manifests"
        state: absent
      when:
        - reset_cluster | bool
        - inventory_hostname in groups['masters']
      ignore_errors: true
      tags:
        - reset

    # ä»»å‹™ï¼šå¼·åˆ¶å¸è¼‰ kubelet æ›è¼‰é»
    - name: å¼·åˆ¶å¸è¼‰ kubelet æ›è¼‰çš„æª”æ¡ˆç³»çµ±
      ansible.builtin.shell: |
        # å¼·åˆ¶å¸è¼‰æ‰€æœ‰ kube-api-access æ›è¼‰é»
        for mount in $(mount | grep kube-api-access | awk '{print $3}'); do
          umount -f "$mount" 2>/dev/null || true
        done
        # å¸è¼‰ kubelet ç›®éŒ„
        umount -f /var/lib/kubelet 2>/dev/null || true
      when: reset_cluster | bool
      ignore_errors: true
      tags:
        - reset

    # ä»»å‹™ï¼šæ¸…ç†ç¶²è·¯é…ç½®ï¼ˆiptables, IPVS, ç¶²è·¯æ¥å£ï¼‰
    - name: æ¸…ç†ç¶²è·¯é…ç½®æ®˜ç•™ï¼ˆiptables, IPVS, æ¥å£ï¼‰
      ansible.builtin.shell: |
        # æ¸…ç† iptables è¦å‰‡
        iptables -F
        iptables -X
        iptables -t nat -F
        iptables -t nat -X
        iptables -t mangle -F
        iptables -t mangle -X

        # æ¸…ç† IPVS è¡¨
        ipvsadm --clear 2>/dev/null || true

        # åˆªé™¤ Kubernetes ç¶²è·¯æ¥å£
        ip link delete tunl0 2>/dev/null || true
        ip link delete kube-ipvs0 2>/dev/null || true

        # æ¸…ç† Calico/BIRD è·¯ç”±
        ip route flush proto bird 2>/dev/null || true

        # é‡å•Ÿç¶²è·¯æœå‹™
        systemctl restart systemd-networkd 2>/dev/null || true
      when: reset_cluster | bool
      ignore_errors: true
      tags:
        - reset

    # ä»»å‹™ï¼šå¼·åˆ¶æ¸…ç†èˆŠé…ç½®ï¼ˆé‡è©¦ä»¥è™•ç†å¿™ç¢Œçš„æª”æ¡ˆï¼‰
    - name: æ¸…ç†æ‰€æœ‰ Kubernetes èˆŠè¨­å®šå’Œè³‡æ–™ç›®éŒ„
      ansible.builtin.command: "rm -rf {{ item }}"
      loop:
        - /etc/kubernetes # Kubernetes è¨­å®šæª”
        - /var/lib/kubelet # Kubelet è³‡æ–™ç›®éŒ„
        - /var/lib/etcd # etcd è³‡æ–™ç›®éŒ„
        - /etc/cni/net.d # CNI ç¶²è·¯è¨­å®š
        - /var/run/kubernetes # Kubernetes åŸ·è¡Œæ™‚ç›®éŒ„
        - /var/lib/cni # CNI è³‡æ–™ç›®éŒ„
      when: reset_cluster | bool
      ignore_errors: true
      retries: 3
      delay: 2
      tags:
        - reset

  # æ‡‰ç”¨è§’è‰²
  roles:
    - common # æ‡‰ç”¨ common è§’è‰²é€²è¡Œç³»çµ±æº–å‚™

# ç¬¬ä¸‰éšæ®µï¼šå¼•å°ä¸¦åŠ å…¥æ§åˆ¶å¹³é¢ç¯€é»
- name: åˆå§‹åŒ–ä¸¦åŠ å…¥æ§åˆ¶å¹³é¢ç¯€é»
  # é‡å° master ç¯€é»åŸ·è¡Œæ§åˆ¶å¹³é¢è¨­ç½®
  hosts: masters
  become: true # ä»¥ root æ¬Šé™åŸ·è¡Œ
  gather_facts: true # æ”¶é›†ç³»çµ±è³‡è¨Š
  serial: 1 # ä¾æ¬¡åŸ·è¡Œï¼Œé¿å…åŒæ™‚åˆå§‹åŒ–é€ æˆè¡çª

  # é ä»»å‹™
  pre_tasks:
    # ä»»å‹™ï¼šç­‰å¾… API server å°±ç·’ï¼ˆç”¨æ–¼é¡å¤–çš„ master ç¯€é»ï¼‰
    - name: ç­‰å¾… API Server å°±ç·’ï¼ˆä¾›é¡å¤–çš„ Master ç¯€é»åŠ å…¥ï¼‰
      ansible.builtin.uri:
        url: "https://{{ control_plane_endpoint }}/healthz" # API server å¥åº·æª¢æŸ¥ç«¯é»ï¼ˆä½¿ç”¨å¯¦éš›ç«¯é»ï¼‰
        validate_certs: false # ä¸é©—è­‰ TLS è­‰æ›¸
        timeout: 5 # è«‹æ±‚è¶…æ™‚æ™‚é–“
      register: api_check # ä¿å­˜æª¢æŸ¥çµæœ
      until: api_check.status == 200 # é‡è©¦ç›´åˆ°ç‹€æ…‹ç‚º 200
      retries: 30 # æœ€å¤§é‡è©¦æ¬¡æ•¸
      delay: 10 # é‡è©¦é–“éš”
      when: inventory_hostname != groups['masters'][0] # åƒ…å°éç¬¬ä¸€å€‹ master åŸ·è¡Œ
      ignore_errors: true # å¿½ç•¥éŒ¯èª¤ï¼ˆç¬¬ä¸€å€‹ master æ²’æœ‰ API serverï¼‰

  # æ‡‰ç”¨è§’è‰²
  roles:
    - master # æ‡‰ç”¨ master è§’è‰²

# ç¬¬å››éšæ®µï¼šå°‡ Worker ç¯€é»åŠ å…¥é›†ç¾¤
- name: å°‡ Worker ç¯€é»åŠ å…¥ Kubernetes é›†ç¾¤
  # é‡å° worker ç¯€é»åŠ å…¥é›†ç¾¤
  hosts: workers
  become: true # ä»¥ root æ¬Šé™åŸ·è¡Œ
  gather_facts: true # æ”¶é›†ç³»çµ±è³‡è¨Š
  serial: 1 # ä¾æ¬¡åŸ·è¡Œï¼Œé¿å…è³‡æºç«¶çˆ­

  # æ‡‰ç”¨è§’è‰²ï¼ˆæ‰€æœ‰é‚è¼¯éƒ½åœ¨ worker è§’è‰²ä¸­ï¼‰
  roles:
    - worker # æ‡‰ç”¨ worker è§’è‰²

# ç¬¬äº”éšæ®µï¼šç”Ÿæˆé…ç½®æª”æ¡ˆï¼ˆæœ¬åœ°åŸ·è¡Œï¼‰
- name: ç”Ÿæˆ TopoLVM é…ç½®æª”æ¡ˆ
  # åœ¨æœ¬åœ°ç”Ÿæˆé…ç½®æª”æ¡ˆï¼Œä¸éœ€è¦é ç¨‹åŸ·è¡Œ
  hosts: localhost
  connection: local
  become: false # æ˜ç¢ºç¦ç”¨ becomeï¼Œå› ç‚º ansible.cfg ä¸­å…¨å±€å•Ÿç”¨äº† become
  gather_facts: false

  tasks:
    # ä»»å‹™ï¼šç”Ÿæˆ TopoLVM é…ç½®æª”æ¡ˆ
    - name: ç”Ÿæˆ TopoLVM Helm values é…ç½®æª”æ¡ˆ
      ansible.builtin.template:
        src: roles/worker/templates/topolvm-values.yaml.j2
        dest: /tmp/topolvm-values.yaml
        mode: "0644"
      run_once: true

# ç¬¬å…­éšæ®µï¼šå®‰è£ NGINX Ingress Controller
- name: å®‰è£ NGINX Ingress Controller
  # åœ¨ç¬¬ä¸€å€‹ master ç¯€é»ä¸Šå®‰è£ NGINX Ingress Controller
  hosts: masters[0]
  become: true # ä»¥ root æ¬Šé™åŸ·è¡Œ
  gather_facts: false # ä¸æ”¶é›†ç³»çµ±è³‡è¨Šä»¥åŠ å¿«é€Ÿåº¦
  tags:
    - ingress # æ¨™ç±¤ç”¨æ–¼é¸æ“‡æ€§åŸ·è¡Œ

  # æ‡‰ç”¨è§’è‰²
  roles:
    - ingress # æ‡‰ç”¨ ingress è§’è‰²å®‰è£ NGINX Ingress Controller

# ç¬¬ä¸ƒéšæ®µï¼šé©—è­‰é›†ç¾¤éƒ¨ç½²
- name: é©—è­‰ Kubernetes é›†ç¾¤éƒ¨ç½²ç‹€æ…‹
  # åœ¨ç¬¬ä¸€å€‹ master ç¯€é»ä¸Šé©—è­‰é›†ç¾¤éƒ¨ç½²çµæœ
  hosts: masters[0]
  become: true # ä»¥ root æ¬Šé™åŸ·è¡Œ
  gather_facts: false # ä¸æ”¶é›†ç³»çµ±è³‡è¨Šä»¥åŠ å¿«é€Ÿåº¦

  # ä»»å‹™åˆ—è¡¨
  tasks:
    # ä»»å‹™ï¼šç­‰å¾…æ‰€æœ‰ Calico pods å°±ç·’
    - name: ç­‰å¾…æ‰€æœ‰ Calico ç¶²è·¯ Pod å°±ç·’
      ansible.builtin.command: kubectl wait --for=condition=Ready pod -l k8s-app=calico-node -n kube-system --timeout=300s --all
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
      register: calico_ready
      changed_when: false
      failed_when: false
      retries: 3
      delay: 10

    # ä»»å‹™ï¼šç­‰å¾…æ‰€æœ‰ç¯€é»å°±ç·’
    - name: ç­‰å¾…æ‰€æœ‰ç¯€é»é€²å…¥ Ready ç‹€æ…‹
      ansible.builtin.shell: |
        # çµ±è¨ˆé Ready ç¯€é»æ•¸é‡
        not_ready=$(kubectl get nodes --no-headers 2>/dev/null | grep -v " Ready " | wc -l)
        echo "$not_ready"
        exit 0
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
      register: not_ready_count
      until: not_ready_count.stdout | trim | int == 0
      retries: 60
      delay: 5
      changed_when: false

    # ä»»å‹™ï¼šé¡¯ç¤ºæœ€çµ‚é›†ç¾¤ç‹€æ…‹
    - name: é¡¯ç¤ºæœ€çµ‚é›†ç¾¤ç¯€é»ç‹€æ…‹
      ansible.builtin.command: kubectl get nodes -o wide # é¡¯ç¤ºç¯€é»è©³ç´°ç‹€æ…‹
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf # æŒ‡å®š kubeconfig
      register: cluster_status # ä¿å­˜é›†ç¾¤ç‹€æ…‹
      changed_when: false # ä¸æ¨™è¨˜ç‚º changed

    # ä»»å‹™ï¼šé¡¯ç¤ºé›†ç¾¤è³‡è¨Šç¸½çµ
    - name: é¡¯ç¤ºé›†ç¾¤éƒ¨ç½²å®Œæˆè³‡è¨Š
      ansible.builtin.debug:
        msg: |
          ğŸ‰ Detectviz Kubernetes é›†ç¾¤éƒ¨ç½²å®Œæˆï¼ğŸ‰

          å·²å®‰è£çµ„ä»¶ï¼š
          âœ… Kubernetes é›†ç¾¤ ({{ cluster_status.stdout_lines | length }} å€‹ç¯€é»)
          âœ… Calico CNI ç¶²è·¯
          âœ… NGINX Ingress Controller
          âœ… MetalLB LoadBalancer (éœ€è¦åœ¨é›†ç¾¤å¤–éƒ¨é…ç½®)

          é›†ç¾¤ç‹€æ…‹ï¼š
          {{ cluster_status.stdout }}

          ç¶²è·¯é…ç½®ï¼š
          - æ§åˆ¶å¹³é¢ç«¯é»ï¼š{{ control_plane_endpoint }}
          - Pod ç¶²è·¯ CIDRï¼š{{ pod_network_cidr }}
          - Service ç¶²è·¯ CIDRï¼š{{ service_cidr }}
          - Ingress Controller: è‡ªå‹•åˆ†é… LoadBalancer IP

          ä¸‹ä¸€æ­¥æ“ä½œï¼š
          1. é©—è­‰é›†ç¾¤ï¼škubectl get nodes
          2. æª¢æŸ¥ Podï¼škubectl get pods -A
          3. æª¢æŸ¥ Ingressï¼škubectl get svc -n ingress-nginx
          4. é€šé ArgoCD/GitOps éƒ¨ç½²æ‡‰ç”¨
