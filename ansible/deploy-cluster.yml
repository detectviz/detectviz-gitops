---
# ==============================================================================
# Detectviz Platform - Ansible ä¸»éƒ¨ç½²åŠ‡æœ¬ (Main Playbook)
#
# åŸ·è¡Œé †åºï¼š
# 1.  **ç¯€é»åˆå§‹åŒ– (Common)**: åœ¨æ‰€æœ‰ç¯€é»ä¸ŠåŸ·è¡Œç³»çµ±æ›´æ–°ã€å®‰è£ containerdã€Kubernetes çµ„ä»¶å’Œå¿…è¦å¥—ä»¶ã€‚
# 2.  **ç¶²è·¯é…ç½® (Network)**: è¨­å®šé›™ç¶²è·¯ä»‹é¢ã€MTU åŠ hostsã€‚
# 3.  **Master ç¯€é»éƒ¨ç½² (Master)**: åˆå§‹åŒ– Kubernetes æ§åˆ¶å¹³é¢ã€å®‰è£ CNIã€‚
# 4.  **Worker ç¯€é»éƒ¨ç½² (Worker)**: å°‡å·¥ä½œç¯€é»åŠ å…¥é›†ç¾¤ã€‚
# 5.  **ç¯€é»æ¨™ç±¤ (Node Labels)**: ç‚ºç‰¹å®šç¯€é»æ·»åŠ æ¨™ç±¤ï¼Œç”¨æ–¼å·¥ä½œè² è¼‰èª¿åº¦ã€‚
# 6.  **ArgoCD éƒ¨ç½² (ArgoCD)**: å®‰è£ä¸¦è¨­å®š ArgoCD GitOps å¼•æ“ã€‚
# 7.  **æœ€çµ‚é©—è­‰ (Validation)**: æª¢æŸ¥é›†ç¾¤ç‹€æ…‹ä¸¦é¡¯ç¤ºéƒ¨ç½²æ‘˜è¦ã€‚
#
# ==============================================================================

- name: "[Phase 1] Prepare all nodes for Kubernetes installation (ç¯€é»åˆå§‹åŒ–)"
  hosts: k8s_cluster
  become: true
  gather_facts: true
  roles:
    - role: common

- name: "[Phase 2] Configure Multi-Network Architecture (ç¶²è·¯é…ç½®)"
  hosts: k8s_cluster
  become: true
  gather_facts: false
  roles:
    - role: network

- name: "[Phase 3] Initialize and join control plane nodes (Master ç¯€é»éƒ¨ç½²)"
  hosts: masters
  become: true
  gather_facts: true
  serial: 1
  roles:
    - role: master

- name: "[Phase 3.5] Generate worker join command (ç”Ÿæˆ Worker åŠ å…¥å‘½ä»¤)"
  hosts: masters[0]
  become: true
  gather_facts: false
  tasks:
    # åœ¨ master-1 ä¸Šç”Ÿæˆ worker ç¯€é»çš„åŠ å…¥å‘½ä»¤
    # æ­¤å‘½ä»¤åŒ…å«: join token, CA cert hash, å’Œæ§åˆ¶å¹³é¢çš„ endpoint
    - name: "Generate kubeadm join command for workers (ç”Ÿæˆ worker åŠ å…¥å‘½ä»¤)"
      ansible.builtin.command: kubeadm token create --print-join-command
      register: worker_join_command_output
      changed_when: false

    # å°‡ç”Ÿæˆçš„ join å‘½ä»¤ä¿å­˜ç‚º fact,ä¾›å¾ŒçºŒä½¿ç”¨
    - name: "Set worker join command as fact (è¨­å®š worker åŠ å…¥å‘½ä»¤ç‚º fact)"
      ansible.builtin.set_fact:
        worker_join_command: "{{ worker_join_command_output.stdout }}"

    # ä½¿ç”¨ add_host å°‡ join å‘½ä»¤å‹•æ…‹æ·»åŠ åˆ°æ‰€æœ‰ worker ç¯€é»çš„è®Šæ•¸ä¸­
    # é€™æ¨£åœ¨ Phase 4 åŸ·è¡Œæ™‚,æ¯å€‹ worker éƒ½èƒ½è¨ªå•åˆ°é€™å€‹å‘½ä»¤
    - name: "Share worker join command to all workers (å°‡ worker åŠ å…¥å‘½ä»¤å…±äº«çµ¦æ‰€æœ‰ worker ç¯€é»)"
      ansible.builtin.add_host:
        name: "{{ item }}"
        worker_join_command: "{{ worker_join_command }}"
      loop: "{{ groups['workers'] }}"

- name: "[Phase 4] Join worker nodes to the cluster (Worker ç¯€é»éƒ¨ç½²)"
  hosts: workers
  become: true
  gather_facts: true
  roles:
    - role: worker

- name: "[Phase 5] Apply Node Labels (ç¯€é»æ¨™ç±¤)"
  hosts: masters[0]
  become: false
  gather_facts: false
  tasks:
    # ç‚ºæ¯å€‹ç¯€é»æ·»åŠ ç‰¹å®šçš„å·¥ä½œè² è¼‰æ¨™ç±¤
    # é€™äº›æ¨™ç±¤ç”¨æ–¼ Pod çš„ nodeSelector,ç¢ºä¿ç‰¹å®šå·¥ä½œè² è¼‰éƒ¨ç½²åˆ°æŒ‡å®šç¯€é»
    # æ³¨æ„: ä½¿ç”¨ --kubeconfig åƒæ•¸æ˜ç¢ºæŒ‡å®šé…ç½®æª”æ¡ˆè·¯å¾‘
    - name: "Label nodes for specific workloads (ç‚ºç¯€é»æ·»åŠ æ¨™ç±¤)"
      ansible.builtin.command: >
        kubectl --kubeconfig=/etc/kubernetes/admin.conf label node {{ item.name }} {{ item.label }} --overwrite
      loop:
        - {
            name: "master-1",
            label: "node-role.kubernetes.io/workload-monitoring=true",  # Grafana, Prometheus
          }
        - {
            name: "master-2",
            label: "node-role.kubernetes.io/workload-mimir=true",       # Mimir (metrics)
          }
        - {
            name: "master-3",
            label: "node-role.kubernetes.io/workload-loki=true",        # Loki (logs)
          }
        - {
            name: "app-worker",
            label: "node-role.kubernetes.io/workload-apps=true",        # ArgoCD, æ‡‰ç”¨ç¨‹å¼
          }
      changed_when: true
      ignore_errors: true
      become: true  # éœ€è¦ root æ¬Šé™è¨ªå• /etc/kubernetes/admin.conf

- name: "[Phase 6] Install ArgoCD and Bootstrap GitOps (ArgoCD éƒ¨ç½²)"
  hosts: masters[0]
  become: false
  gather_facts: false
  vars:
    argocd_install_manifest: "https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml"
    argocd_node_selector:
      node-role.kubernetes.io/workload-apps: "true"
  # è¨­å®š KUBECONFIG ç’°å¢ƒè®Šæ•¸,è®“ kubernetes.core.k8s æ¨¡çµ„å¯ä»¥é€£æ¥åˆ°é›†ç¾¤
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  tasks:
    # å»ºç«‹ ArgoCD å°ˆç”¨çš„å‘½åç©ºé–“
    # æ³¨æ„: kubernetes.core.k8s æ¨¡çµ„éœ€è¦ Python kubernetes å®¢æˆ¶ç«¯ (å·²åœ¨ common role å®‰è£)
    - name: "Ensure ArgoCD namespace exists (ç¢ºä¿ ArgoCD å‘½åç©ºé–“å­˜åœ¨)"
      kubernetes.core.k8s:
        name: argocd
        api_version: v1
        kind: Namespace
        state: present
      become: true  # éœ€è¦ root æ¬Šé™è¨ªå• kubeconfig

    # ä¸‹è¼‰ ArgoCD å®˜æ–¹å®‰è£æ¸…å–®åˆ°æœ¬åœ°
    - name: "Download ArgoCD install manifest (ä¸‹è¼‰ ArgoCD å®‰è£æ¸…å–®)"
      ansible.builtin.get_url:
        url: "{{ argocd_install_manifest }}"
        dest: "/tmp/argocd-install.yaml"
        mode: "0644"

    # æ‡‰ç”¨ ArgoCD manifest åˆ°é›†ç¾¤ (ä¸ä¿®æ”¹ nodeSelector)
    # ä¸ç­‰å¾…å°±ç·’,å› ç‚ºæŸäº›çµ„ä»¶ (å¦‚ dex-server) å¯èƒ½éœ€è¦è¼ƒé•·æ™‚é–“å•Ÿå‹•
    - name: "Apply ArgoCD install manifest (æ‡‰ç”¨ ArgoCD å®‰è£æ¸…å–®)"
      kubernetes.core.k8s:
        state: present
        src: "/tmp/argocd-install.yaml"
        namespace: argocd
        wait: no
      become: true

    # ç‚ºæ‰€æœ‰ ArgoCD çµ„ä»¶æ·»åŠ  nodeSelector,ç¢ºä¿åªéƒ¨ç½²åˆ° app-worker ç¯€é»
    # ä½¿ç”¨ kubectl patch è€Œé yq ä¿®æ”¹æ–‡ä»¶,æ›´å¯é ä¸”ä¸æœƒç ´å£ YAML çµæ§‹
    - name: "Patch ArgoCD deployments with nodeSelector (ç‚º ArgoCD Deployments æ·»åŠ  nodeSelector)"
      ansible.builtin.command: >
        kubectl --kubeconfig=/etc/kubernetes/admin.conf -n argocd patch deployment {{ item }}
        -p='{"spec":{"template":{"spec":{"nodeSelector":{"node-role.kubernetes.io/workload-apps":"true"}}}}}'
      loop:
        - argocd-applicationset-controller
        - argocd-dex-server
        - argocd-notifications-controller
        - argocd-redis
        - argocd-repo-server
        - argocd-server
      become: true
      changed_when: true
      ignore_errors: true  # å…è¨±deploymentä¸å­˜åœ¨çš„éŒ¯èª¤

    # ç‚º StatefulSet æ·»åŠ  nodeSelector
    - name: "Patch ArgoCD statefulset with nodeSelector (ç‚º ArgoCD StatefulSet æ·»åŠ  nodeSelector)"
      ansible.builtin.command: >
        kubectl --kubeconfig=/etc/kubernetes/admin.conf -n argocd patch statefulset argocd-application-controller
        -p='{"spec":{"template":{"spec":{"nodeSelector":{"node-role.kubernetes.io/workload-apps":"true"}}}}}'
      become: true
      changed_when: true
      ignore_errors: true

    # ArgoCD v3.2.0+ éœ€è¦ server.secretkey æ‰èƒ½å•Ÿå‹• dex-server
    # ç”Ÿæˆéš¨æ©Ÿçš„ 32 å­—ç¯€ base64 ç·¨ç¢¼ secret key
    - name: "Generate ArgoCD server secret key (ç”Ÿæˆ ArgoCD server secret key)"
      ansible.builtin.shell: openssl rand -base64 32
      register: argocd_secret_key
      changed_when: false

    # å°‡ secret key æ·»åŠ åˆ° argocd-secret
    - name: "Patch ArgoCD secret with server.secretkey (æ·»åŠ  server.secretkey åˆ° ArgoCD secret)"
      ansible.builtin.command: >
        kubectl --kubeconfig=/etc/kubernetes/admin.conf -n argocd patch secret argocd-secret
        -p='{"stringData": {"server.secretkey": "{{ argocd_secret_key.stdout }}"}}'
      become: true
      changed_when: true

    # ç­‰å¾… ArgoCD Server Pod å°±ç·’ (é€™æ˜¯æœ€é—œéµçš„çµ„ä»¶)
    - name: "Wait for ArgoCD Server to be ready (ç­‰å¾… ArgoCD Server å°±ç·’)"
      ansible.builtin.command: >
        kubectl --kubeconfig=/etc/kubernetes/admin.conf wait --for=condition=Ready
        pod -l app.kubernetes.io/name=argocd-server -n argocd --timeout=600s
      become: true
      changed_when: false
      ignore_errors: true  # å¦‚æœè¶…æ™‚,ç¹¼çºŒåŸ·è¡Œ,è®“ä½¿ç”¨è€…å¯ä»¥æ‰‹å‹•æª¢æŸ¥

    # é…ç½® Git Repository SSH èªè­‰
    # Root Application ä½¿ç”¨ SSH URL è¨ªå• GitHub,éœ€è¦é…ç½® deploy key
    # æª¢æŸ¥ SSH ç§é‘°æ˜¯å¦å­˜åœ¨
    - name: "Check if SSH private key exists (æª¢æŸ¥ SSH ç§é‘°æ˜¯å¦å­˜åœ¨)"
      ansible.builtin.stat:
        path: "{{ lookup('env', 'HOME') }}/.ssh/id_ed25519_detectviz"
      register: ssh_key_stat
      delegate_to: localhost
      become: false

    # å¦‚æœ SSH é‡‘é‘°å­˜åœ¨,é…ç½® ArgoCD repository èªè­‰
    - name: "Configure ArgoCD Git Repository authentication (é…ç½® ArgoCD Git Repository èªè­‰)"
      when: ssh_key_stat.stat.exists
      block:
        # è¤‡è£½ SSH ç§é‘°åˆ°è‡¨æ™‚ä½ç½®
        - name: "Copy SSH private key to remote host (è¤‡è£½ SSH ç§é‘°åˆ°é ç«¯ä¸»æ©Ÿ)"
          ansible.builtin.copy:
            src: "{{ lookup('env', 'HOME') }}/.ssh/id_ed25519_detectviz"
            dest: "/tmp/argocd-ssh-key"
            mode: "0600"

        # å»ºç«‹ ArgoCD repository secret
        - name: "Create ArgoCD repository secret (å»ºç«‹ ArgoCD repository secret)"
          ansible.builtin.command: >
            kubectl --kubeconfig=/etc/kubernetes/admin.conf create secret generic detectviz-gitops-repo
            --from-file=sshPrivateKey=/tmp/argocd-ssh-key
            -n argocd
            --dry-run=client -o yaml
          register: repo_secret_yaml
          changed_when: false
          become: true

        - name: "Apply ArgoCD repository secret (æ‡‰ç”¨ ArgoCD repository secret)"
          kubernetes.core.k8s:
            state: present
            definition: "{{ repo_secret_yaml.stdout | from_yaml }}"
            namespace: argocd
          become: true

        # æ·»åŠ æ¨™ç±¤è®“ ArgoCD è­˜åˆ¥ç‚º repository credential
        - name: "Label repository secret (ç‚º repository secret æ·»åŠ æ¨™ç±¤)"
          ansible.builtin.command: >
            kubectl --kubeconfig=/etc/kubernetes/admin.conf label secret detectviz-gitops-repo
            argocd.argoproj.io/secret-type=repository
            -n argocd --overwrite
          become: true
          changed_when: true

        # é…ç½® repository URL å’Œé¡å‹
        - name: "Configure repository URL (é…ç½® repository URL)"
          ansible.builtin.command: >
            kubectl --kubeconfig=/etc/kubernetes/admin.conf patch secret detectviz-gitops-repo
            -n argocd
            -p='{"stringData":{"type":"git","url":"git@github.com:detectviz/detectviz-gitops.git"}}'
          become: true
          changed_when: true

        # ç²å– GitHub SSH known_hosts
        - name: "Get GitHub SSH known_hosts (ç²å– GitHub SSH known_hosts)"
          ansible.builtin.command: ssh-keyscan github.com
          register: github_known_hosts
          changed_when: false
          delegate_to: localhost
          become: false

        # å»ºç«‹ known_hosts secret
        - name: "Create SSH known_hosts secret (å»ºç«‹ SSH known_hosts secret)"
          kubernetes.core.k8s:
            state: present
            definition:
              apiVersion: v1
              kind: Secret
              metadata:
                name: argocd-ssh-known-hosts
                namespace: argocd
              type: Opaque
              stringData:
                ssh_known_hosts: "{{ github_known_hosts.stdout }}"
          become: true

        # é‡å•Ÿ ArgoCD repo-server ä»¥è¼‰å…¥æ–°çš„èªè­‰
        - name: "Restart ArgoCD repo-server (é‡å•Ÿ ArgoCD repo-server)"
          ansible.builtin.command: >
            kubectl --kubeconfig=/etc/kubernetes/admin.conf rollout restart deployment argocd-repo-server -n argocd
          become: true
          changed_when: true

        # ç­‰å¾… repo-server é‡å•Ÿå®Œæˆ
        - name: "Wait for repo-server restart (ç­‰å¾… repo-server é‡å•Ÿå®Œæˆ)"
          ansible.builtin.command: >
            kubectl --kubeconfig=/etc/kubernetes/admin.conf rollout status deployment argocd-repo-server
            -n argocd --timeout=60s
          become: true
          changed_when: false

        # æ¸…ç†è‡¨æ™‚ SSH é‡‘é‘°
        - name: "Clean up temporary SSH key (æ¸…ç†è‡¨æ™‚ SSH é‡‘é‘°)"
          ansible.builtin.file:
            path: "/tmp/argocd-ssh-key"
            state: absent

    # å¦‚æœ SSH é‡‘é‘°ä¸å­˜åœ¨,é¡¯ç¤ºè­¦å‘Šè¨Šæ¯
    - name: "Display warning if SSH key not found (é¡¯ç¤º SSH é‡‘é‘°æœªæ‰¾åˆ°çš„è­¦å‘Š)"
      ansible.builtin.debug:
        msg: |
          âš ï¸  WARNING: SSH ç§é‘°æœªæ‰¾åˆ°!

          è·¯å¾‘: {{ lookup('env', 'HOME') }}/.ssh/id_ed25519_detectviz

          Root Application å°‡ç„¡æ³•åŒæ­¥ GitHub repositoryã€‚
          è«‹åŸ·è¡Œä»¥ä¸‹æ­¥é©Ÿé…ç½® SSH èªè­‰:

          1. ç”Ÿæˆ SSH é‡‘é‘°:
             ssh-keygen -t ed25519 -C "argocd-deploy-key" -f ~/.ssh/id_ed25519_detectviz -N ""

          2. å°‡å…¬é‘°æ·»åŠ åˆ° GitHub repository çš„ Deploy Keys:
             https://github.com/detectviz/detectviz-gitops/settings/keys

          3. é‡æ–°åŸ·è¡Œéƒ¨ç½²æˆ–æ‰‹å‹•é…ç½®èªè­‰:
             åƒè€ƒæ–‡ä»¶: ansible/ARGOCD_GIT_REPOSITORY_SETUP.md
      when: not ssh_key_stat.stat.exists

    # éƒ¨ç½² ArgoCD Root Application (App of Apps æ¨¡å¼)
    # é€™å€‹æ‡‰ç”¨æœƒè‡ªå‹•ç®¡ç†å…¶ä»–æ‰€æœ‰åŸºç¤è¨­æ–½æ‡‰ç”¨ (Grafana, Loki, Mimir, etc.)
    # å…ˆå°‡ root application manifest è¤‡è£½åˆ°é ç«¯ä¸»æ©Ÿ
    - name: "Copy ArgoCD Root Application manifest to remote host (è¤‡è£½ ArgoCD æ ¹æ‡‰ç”¨ç¨‹å¼ manifest åˆ°é ç«¯ä¸»æ©Ÿ)"
      ansible.builtin.copy:
        src: "{{ playbook_dir }}/../argocd/root-argocd-app.yaml"
        dest: "/tmp/root-argocd-app.yaml"
        mode: "0644"

    # æ‡‰ç”¨ Root Application manifest
    - name: "Bootstrap ArgoCD Root Application (å•Ÿå‹• ArgoCD æ ¹æ‡‰ç”¨ç¨‹å¼)"
      kubernetes.core.k8s:
        state: present
        src: "/tmp/root-argocd-app.yaml"
        namespace: argocd
      become: true

    # å¦‚æœ SSH é‡‘é‘°å·²é…ç½®,å¼·åˆ¶åˆ·æ–° root application
    - name: "Force refresh root application (å¼·åˆ¶åˆ·æ–° root application)"
      ansible.builtin.command: >
        kubectl --kubeconfig=/etc/kubernetes/admin.conf patch application root
        -n argocd
        -p='{"metadata":{"annotations":{"argocd.argoproj.io/refresh":"hard"}}}'
        --type=merge
      become: true
      changed_when: true
      when: ssh_key_stat.stat.exists

    # ç­‰å¾… root application åŒæ­¥
    - name: "Wait for root application to sync (ç­‰å¾… root application åŒæ­¥)"
      ansible.builtin.pause:
        seconds: 10
      when: ssh_key_stat.stat.exists

- name: "[Phase 7] Validate Kubernetes Cluster Deployment (æœ€çµ‚é©—è­‰)"
  hosts: masters[0]
  become: true
  gather_facts: false
  tasks:
    # ç­‰å¾…æ‰€æœ‰ç¯€é»é€²å…¥ Ready ç‹€æ…‹ (æœ€å¤šç­‰å¾… 5 åˆ†é˜)
    # é€™ç¢ºä¿ CNI ç¶²è·¯æ’ä»¶å·²åˆå§‹åŒ–å®Œæˆ
    # æ³¨æ„: ä½¿ç”¨ --kubeconfig åƒæ•¸æ˜ç¢ºæŒ‡å®šé…ç½®æª”æ¡ˆ
    - name: "Wait for all nodes to be in Ready state (ç­‰å¾…æ‰€æœ‰ç¯€é»é€²å…¥ Ready ç‹€æ…‹)"
      ansible.builtin.command: kubectl --kubeconfig=/etc/kubernetes/admin.conf wait --for=condition=Ready node --all --timeout=5m
      changed_when: false

    # ç²å–æœ€çµ‚çš„é›†ç¾¤ç¯€é»ç‹€æ…‹,åŒ…å«è©³ç´°è³‡è¨Š
    - name: "Get final cluster node status (ç²å–æœ€çµ‚é›†ç¾¤ç¯€é»ç‹€æ…‹)"
      ansible.builtin.command: kubectl --kubeconfig=/etc/kubernetes/admin.conf get nodes -o wide
      register: cluster_status
      changed_when: false

    - name: "Display deployment completion summary (é¡¯ç¤ºéƒ¨ç½²æ‘˜è¦)"
      ansible.builtin.debug:
        msg: |
          ======================================================================
          ğŸ‰ DetectViz Kubernetes Cluster Deployment Completed Successfully! ğŸ‰
          ======================================================================

          Kubernetes Version: {{ kubernetes_version }}
          Cluster Nodes:
          {{ cluster_status.stdout }}

          Access Points:
          â€¢ Kubernetes API: https://{{ control_plane_vip }}:6443
          â€¢ ArgoCD UI:      https://argocd.detectviz.internal (æˆ– kubectl port-forward)
          â€¢ Grafana:        https://grafana.detectviz.internal

          Next Steps:
          1.  **Vault Initialization**: Manually unseal Vault instances.
          2.  **ArgoCD Sync**: Log in to ArgoCD UI and sync the applications.
          3.  **Verify Workloads**: Check if all application pods are running correctly.

          ======================================================================
