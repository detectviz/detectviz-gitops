---
- name: Prepare all nodes for Kubernetes installation (æº–å‚™æ‰€æœ‰ç¯€é»žé€²è¡Œ Kubernetes å®‰è£)
  hosts: k8s_cluster
  become: true
  gather_facts: true
  roles:
    - role: common

- name: Configure Multi-Network Architecture (é…ç½®å¤šç¶²è·¯æž¶æ§‹)
  hosts: k8s_cluster
  become: true
  gather_facts: false
  roles:
    - role: network

- name: Initialize and join control plane nodes (åˆå§‹åŒ–ä¸¦åŠ å…¥æŽ§åˆ¶å¹³é¢ç¯€é»ž)
  hosts: masters
  become: true
  gather_facts: true
  serial: 1
  roles:
    - role: master

- name: Join worker nodes to the cluster (å°‡å·¥ä½œç¯€é»žåŠ å…¥é›†ç¾¤)
  hosts: workers
  become: true
  gather_facts: true
  roles:
    - role: worker

- name: "[P2.5] Apply Node Labels ([P2.5] åŠ å…¥ç¯€é»žæ¨™ç±¤)"
  hosts: masters[0]
  become: false
  gather_facts: false
  tasks:
    - name: Label master-1 for Prometheus (ç‚º master-1 ç¯€é»žæ·»åŠ  Prometheus æ¨™ç±¤)
      ansible.builtin.command: >
        kubectl label node master-1
        node-role.kubernetes.io/workload-monitoring=true
        --overwrite
      changed_when: true

    - name: Label master-2 for Mimir (ç‚º master-2 ç¯€é»žæ·»åŠ  Mimir æ¨™ç±¤)
      ansible.builtin.command: >
        kubectl label node master-2
        node-role.kubernetes.io/workload-mimir=true
        --overwrite
      changed_when: true

    - name: Label master-3 for Loki (ç‚º master-3 ç¯€é»žæ·»åŠ  Loki æ¨™ç±¤)
      ansible.builtin.command: >
        kubectl label node master-3
        node-role.kubernetes.io/workload-loki=true
        --overwrite
      changed_when: true

    - name: Label app-worker for Applications (ç‚º app-worker ç¯€é»žæ·»åŠ æ‡‰ç”¨æ¨™ç±¤)
      ansible.builtin.command: >
        kubectl label node app-worker
        node-role.kubernetes.io/workload-apps=true
        --overwrite
      changed_when: true

- name: "[P2.5] Install ArgoCD with SSH Key Injection ([P2.5] å®‰è£ ArgoCD èˆ‡æ³¨å…¥ SSH å¯†é‘°)"
  hosts: masters[0]
  become: false
  gather_facts: false
  vars:
    gitops_ssh_key_path: "secrets/id_gitops"
  tasks:
    - name: Ensure ArgoCD namespace exists (ç¢ºä¿ ArgoCD å‘½åç©ºé–“å­˜åœ¨)
      kubernetes.core.k8s:
        name: argocd
        api_version: v1
        kind: Namespace
        state: present

    - name: Create ArgoCD SSH Secret (å»ºç«‹ ArgoCD SSH Secret)
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: argocd-ssh-creds
            namespace: argocd
            labels:
              argocd.argoproj.io/secret-type: repository
          type: Opaque
          data:
            sshPrivateKey: "{{ lookup('file', gitops_ssh_key_path) | b64encode }}"
            url: "git@github.com:detectviz/detectviz-gitops.git"

- name: "[P3] GitOps Bootstrap ([P3] GitOps å•Ÿå‹•ç¨‹åº Bootstrap)"
  hosts: masters[0]
  become: false
  gather_facts: false
  vars:
    argocd_install_manifest: "https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml"
    argocd_node_selector:
      node-role.kubernetes.io/workload-apps: "true"
  tasks:
    - name: Download ArgoCD install manifest (ä¸‹è¼‰ ArgoCD å®‰è£æ¸…å–®)
      ansible.builtin.get_url:
        url: "{{ argocd_install_manifest }}"
        dest: "/tmp/argocd-install.yaml"
        mode: "0644"

    - name: Add nodeSelector to ArgoCD core components (ç‚º ArgoCD æ ¸å¿ƒçµ„ä»¶æ·»åŠ  nodeSelector)
      ansible.builtin.shell: |
        # ä½¿ç”¨ yq ç‚ºæŒ‡å®šçš„ ArgoCD çµ„ä»¶æ·»åŠ  nodeSelector
        yq eval 'select(.kind == "{{ item.kind }}" and .metadata.name == "{{ item.name }}").spec.template.spec.nodeSelector = {{ argocd_node_selector | to_json }}' \
          -i "/tmp/argocd-install.yaml"
      args:
        executable: /bin/bash
      loop:
        - { kind: "Deployment", name: "argocd-repo-server" }
        - { kind: "Deployment", name: "argocd-applicationset-controller" }
        - { kind: "Deployment", name: "argocd-dex-server" }
        - { kind: "Deployment", name: "argocd-server" }
        - { kind: "StatefulSet", name: "argocd-application-controller" }

    - name: Apply ArgoCD install manifest (æ‡‰ç”¨ ArgoCD å®‰è£æ¸…å–®)
      kubernetes.core.k8s:
        state: present
        src: "/tmp/argocd-install.yaml"
        namespace: argocd
        wait: yes
        timeout: 300

    - name: "[P3] Bootstrap ArgoCD Root Application (App-of-Apps) ([P3] ArgoCD å•Ÿå‹•åŠ å…¥ k8s ä»»å‹™ Root Application (App-of-Apps))"
      kubernetes.core.k8s:
        state: present
        src: "{{ playbook_dir }}/../argocd/root-argocd-app.yaml"
        namespace: argocd

- name: Fix VM hostnames if needed (ä¿®å¾© VM ä¸»æ©Ÿåå¦‚æœ‰éœ€è¦)
  hosts: k8s_cluster
  become: true
  gather_facts: false
  tasks:
    - name: Check and fix hostname for master nodes (æª¢æŸ¥ä¸¦ä¿®å¾© master ç¯€é»žçš„ä¸»æ©Ÿå)
      ansible.builtin.command: >
        hostname | grep -q "master-" || (
          case $(hostname) in
            vm-1) NEW_HOSTNAME="master-1" ;;
            vm-2) NEW_HOSTNAME="master-2" ;;
            vm-3) NEW_HOSTNAME="master-3" ;;
            *) NEW_HOSTNAME=$(hostname) ;;
          esac
          sudo hostnamectl set-hostname "$NEW_HOSTNAME.{{ domain }}"
          echo "127.0.0.1 $NEW_HOSTNAME.{{ domain }} $NEW_HOSTNAME" | sudo tee -a /etc/hosts
          echo "Fixed hostname to $NEW_HOSTNAME"
        )
      changed_when: false
      when: "'masters' in group_names"

- name: Validate Kubernetes Cluster Deployment (é©—è­‰ Kubernetes é›†ç¾¤éƒ¨ç½²)
  hosts: masters[0]
  become: false
  gather_facts: false
  tasks:
    - name: Wait for all nodes to be in Ready state (ç­‰å¾…æ‰€æœ‰ç¯€é»žè™•æ–¼ Ready ç‹€æ…‹)
      ansible.builtin.command: kubectl wait --for=condition=Ready node --all --timeout=5m
      changed_when: false

    - name: Get final cluster node status (ç²å–æœ€çµ‚é›†ç¾¤ç¯€é»žç‹€æ…‹)
      ansible.builtin.command: kubectl get nodes -o wide
      register: cluster_status
      changed_when: false

    - name: Display cluster deployment completion message
      ansible.builtin.debug:
        msg: |
          ðŸŽ‰ Detectviz Kubernetes Cluster Deployment Completed! ðŸŽ‰

          Installed Components:
          Kubernetes Cluster ({{ (cluster_status.stdout_lines | length) - 1 }} nodes)
          [âœ“] Calico CNI Networking
          [âœ“] Kube-VIP for Control Plane HA
          [âœ“] ArgoCD GitOps Engine (Bootstrapped)

          Cluster Status:
          {{ cluster_status.stdout }}

          Next Steps:
          1. Verify Vault manual unseal and setup process.
          2. Manually sync P5 applications in ArgoCD UI.
          3. Monitor GitOps sync status: `argocd app list`

    - name: "[P6] Final cluster health check"
      ansible.builtin.command: |
        echo "=== Final Cluster Health Report ==="
        echo "Nodes:"
        kubectl get nodes -o wide
        echo ""
        echo "System pods (non-running):"
        kubectl get pods -A --field-selector=status.phase!=Running 2>/dev/null | head -10 || echo "All system pods running"
        echo ""
        echo "Recent events:"
        kubectl get events --sort-by=.lastTimestamp | tail -5
      become: false
      register: final_health
      changed_when: false
      failed_when: false

    - name: "[P6] Display deployment completion summary"
      ansible.builtin.debug:
        msg: |
          ============================================
          ðŸŽ‰ DetectViz Kubernetes Deployment Complete!
          ============================================

          Final Status: {{ final_health.stdout | default('Health check completed') }}

          Access Points:
          â€¢ Kubernetes API: https://{{ control_plane_vip }}:6443
          â€¢ ArgoCD UI: https://argocd.detectviz.internal
          â€¢ Grafana: https://grafana.detectviz.local
          â€¢ Keycloak: https://keycloak.detectviz.local

          Management Commands:
          â€¢ kubectl --kubeconfig=kubeconfig/admin.conf get nodes
          â€¢ argocd login argocd.detectviz.internal
          â€¢ argocd app list

          Next Steps:
          1. Complete Vault initialization (unseal manually)
          2. Sync P5 applications in ArgoCD UI
          3. Verify application workloads are running
          ============================================
      when: final_health is defined
