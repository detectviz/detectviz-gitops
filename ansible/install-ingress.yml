---
# ============================================
# NGINX Ingress Controller å®‰è£ Playbook
# ç”¨æ–¼åœ¨å·²å­˜åœ¨çš„ Kubernetes é›†ç¾¤ä¸Šå®‰è£ NGINX Ingress Controller
# ============================================

- name: å®‰è£ NGINX Ingress Controller
  # åœ¨ç¬¬ä¸€å€‹ master ç¯€é»ä¸Šå®‰è£ NGINX Ingress Controller
  hosts: masters[0]
  become: true # ä»¥ root æ¬Šé™åŸ·è¡Œ
  gather_facts: false # ä¸æ”¶é›†ç³»çµ±è³‡è¨Šä»¥åŠ å¿«é€Ÿåº¦

  # è®Šæ•¸å®šç¾©
  vars:
    control_plane_endpoint: "192.168.0.11" # æ ¹æ“šå¯¦éš›ç’°å¢ƒä¿®æ”¹
    calico_manifest_url: "https://docs.projectcalico.org/manifests/calico.yaml"

  # é ä»»å‹™
  pre_tasks:
    - name: æª¢æŸ¥å¿…è¦çš„è®Šæ•¸
      ansible.builtin.assert:
        that:
          - control_plane_endpoint is defined
        fail_msg: "âŒ control_plane_endpoint è®Šæ•¸æœªå®šç¾©"

    - name: é¡¯ç¤ºå®‰è£è³‡è¨Š
      ansible.builtin.debug:
        msg: |
          ğŸš€ é–‹å§‹å®‰è£ NGINX Ingress Controller
          ğŸ“ ç›®æ¨™é›†ç¾¤: {{ control_plane_endpoint }}
          ğŸ‘¤ åŸ·è¡Œç¯€é»: {{ inventory_hostname }}

  # æ‡‰ç”¨è§’è‰²
  roles:
    - ingress # æ‡‰ç”¨ ingress è§’è‰²å®‰è£ NGINX Ingress Controller

  # å¾Œä»»å‹™
  post_tasks:
    - name: é¡¯ç¤ºå®‰è£å®Œæˆè³‡è¨Š
      ansible.builtin.debug:
        msg: |
          âœ… NGINX Ingress Controller å®‰è£å®Œæˆï¼

          ğŸ“‹ é©—è­‰æ­¥é©Ÿ:
          1. æª¢æŸ¥ pods: kubectl get pods -n ingress-nginx
          2. æª¢æŸ¥ service: kubectl get svc -n ingress-nginx
          3. æ¸¬è©¦è¨ªå•: curl -k https://192.168.0.10

          ğŸ”— è¨ªå•åœ°å€: https://argocd.detectviz.local (éœ€è¦é…ç½® DNS æˆ– /etc/hosts)
