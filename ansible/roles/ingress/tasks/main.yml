---
# ============================================
# Ingress è§’è‰²ä»»å‹™ - NGINX Ingress Controller å®‰è£
# ============================================

# ============================================
# éšæ®µ 1: æª¢æŸ¥å‰ç½®æ¢ä»¶
# ============================================

- name: æª¢æŸ¥ Kubernetes API æœå‹™å™¨æ˜¯å¦å¯è¨ªå•
  ansible.builtin.uri:
    url: "https://{{ control_plane_endpoint }}:6443/healthz"
    validate_certs: false
    timeout: 10
  register: api_server_check
  failed_when: false # ä¸è®“æª¢æŸ¥å¤±æ•—ï¼Œè®“å¾ŒçºŒé‚è¼¯è™•ç†
  when: inventory_hostname == groups['masters'][0]

- name: é¡¯ç¤º API æœå‹™å™¨æª¢æŸ¥çµæœ
  ansible.builtin.debug:
    msg: "API æœå‹™å™¨æª¢æŸ¥: {{ 'æˆåŠŸ' if api_server_check.status == 200 else 'å¤±æ•—' }}"
  when: inventory_hostname == groups['masters'][0]

- name: æª¢æŸ¥é›†ç¾¤ç‹€æ…‹æ±ºå®šæ˜¯å¦å®‰è£ Ingress
  ansible.builtin.debug:
    msg: "é›†ç¾¤ API æœå‹™å™¨ä¸å¯è¨ªå•ï¼Œè·³é NGINX Ingress Controller å®‰è£ï¼ˆå°‡åœ¨é›†ç¾¤å°±ç·’å¾Œé‡è©¦ï¼‰"
  when:
    - inventory_hostname == groups['masters'][0]
    - api_server_check.status is not defined or api_server_check.status != 200

- name: è·³éå¾ŒçºŒä»»å‹™ï¼ˆé›†ç¾¤æœªå°±ç·’ï¼‰
  ansible.builtin.meta: end_host
  when:
    - inventory_hostname == groups['masters'][0]
    - api_server_check.status is not defined or api_server_check.status != 200

# ============================================
# éšæ®µ 2: ä¸‹è¼‰ä¸¦å®‰è£ NGINX Ingress Controller
# ============================================

- name: å»ºç«‹ NGINX Ingress Controller å‘½åç©ºé–“
  ansible.builtin.command: "kubectl create namespace ingress-nginx --dry-run=client -o yaml | kubectl apply -f -"
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  when: inventory_hostname == groups['masters'][0]
  register: create_namespace
  changed_when: "'created' in create_namespace.stdout or 'configured' in create_namespace.stdout"

- name: ä¸‹è¼‰ä¸¦æ‡‰ç”¨ NGINX Ingress Controller å®˜æ–¹æ¸…å–®
  ansible.builtin.shell: |
    # ä½¿ç”¨å®˜æ–¹æ¨è–¦çš„å®‰è£æ–¹å¼
    kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.11.2/deploy/static/provider/cloud/deploy.yaml
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  when: inventory_hostname == groups['masters'][0]
  register: install_ingress
  changed_when: "'created' in install_ingress.stdout or 'configured' in install_ingress.stdout"

- name: ç­‰å¾… NGINX Ingress Controller éƒ¨ç½²å°±ç·’
  ansible.builtin.command: kubectl wait --for=condition=available --timeout=300s deployment/ingress-nginx-controller -n ingress-nginx
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  when: inventory_hostname == groups['masters'][0]
  register: wait_deployment
  until: wait_deployment.rc == 0
  retries: 3
  delay: 10

# ============================================
# éšæ®µ 3: é©—è­‰å®‰è£
# ============================================

- name: æª¢æŸ¥ NGINX Ingress Controller Pod ç‹€æ…‹
  ansible.builtin.command: kubectl get pods -n ingress-nginx -o wide
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  when: inventory_hostname == groups['masters'][0]
  register: check_pods
  changed_when: false

- name: é¡¯ç¤º Pod ç‹€æ…‹
  ansible.builtin.debug:
    msg: |
      === NGINX Ingress Controller Pod ç‹€æ…‹ ===
      {{ check_pods.stdout }}
  when: inventory_hostname == groups['masters'][0]

- name: æª¢æŸ¥ NGINX Ingress Controller Service ç‹€æ…‹
  ansible.builtin.command: kubectl get svc -n ingress-nginx
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  when: inventory_hostname == groups['masters'][0]
  register: check_service
  changed_when: false

- name: é¡¯ç¤º Service ç‹€æ…‹
  ansible.builtin.debug:
    msg: |
      === NGINX Ingress Controller Service ç‹€æ…‹ ===
      {{ check_service.stdout }}
  when: inventory_hostname == groups['masters'][0]

# ============================================
# éšæ®µ 4: å‰µå»ºæ¸¬è©¦è³‡æºé©—è­‰åŠŸèƒ½
# ============================================

- name: å‰µå»ºæ¸¬è©¦ç”¨çš„ Ingress è³‡æº
  ansible.builtin.shell: |
    cat <<'EOF' | kubectl apply -f -
    apiVersion: networking.k8s.io/v1
    kind: Ingress
    metadata:
      name: test-ingress
      namespace: default
      annotations:
        nginx.ingress.kubernetes.io/rewrite-target: /
    spec:
      ingressClassName: nginx
      rules:
      - host: test.local
        http:
          paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: kubernetes
                port:
                  number: 443
    EOF
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  when: inventory_hostname == groups['masters'][0]
  register: create_test_ingress
  changed_when: "'created' in create_test_ingress.stdout"

- name: é©—è­‰ Ingress è³‡æºå‰µå»ºæˆåŠŸ
  ansible.builtin.command: kubectl get ingress test-ingress -n default
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  when: inventory_hostname == groups['masters'][0]
  register: verify_ingress
  changed_when: false

- name: é¡¯ç¤º Ingress é©—è­‰çµæœ
  ansible.builtin.debug:
    msg: |
      === Ingress è³‡æºé©—è­‰ ===
      {{ verify_ingress.stdout }}
  when: inventory_hostname == groups['masters'][0]

# ============================================
# éšæ®µ 5: æ¸…ç†æ¸¬è©¦è³‡æº
# ============================================

- name: æ¸…ç†æ¸¬è©¦ç”¨çš„ Ingress è³‡æº
  ansible.builtin.command: kubectl delete ingress test-ingress -n default --ignore-not-found=true
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  when: inventory_hostname == groups['masters'][0]
  register: cleanup_test
  changed_when: "'deleted' in cleanup_test.stdout"

# ============================================
# éšæ®µ 6: å®‰è£ç¸½çµ
# ============================================

- name: é¡¯ç¤º NGINX Ingress Controller å®‰è£å®Œæˆè³‡è¨Š
  ansible.builtin.debug:
    msg: |
      ğŸ‰ NGINX Ingress Controller å®‰è£å®Œæˆï¼ğŸ‰

      å®‰è£æ‘˜è¦ï¼š
      - å‘½åç©ºé–“: ingress-nginx
      - æ§åˆ¶å™¨: ingress-nginx-controller
      - Service: ingress-nginx-controller (LoadBalancer)
      - Ingress Class: nginx

      ä¸‹ä¸€æ­¥æ“ä½œï¼š
      1. é©—è­‰å¤–éƒ¨è¨ªå•: kubectl get svc -n ingress-nginx
      2. æª¢æŸ¥ Ingress è³‡æº: kubectl get ingress -A
      3. é…ç½® DNS æˆ– /etc/hosts æŒ‡å‘ LoadBalancer IP
  when: inventory_hostname == groups['masters'][0]
