# ============================================
# Kubeadm 集群配置模板
# 用於初始化 Detectviz Kubernetes 集群
# ============================================

# InitConfiguration - 初始化配置
apiVersion: kubeadm.k8s.io/v1beta4
kind: InitConfiguration
nodeRegistration:
  criSocket: "unix:///var/run/containerd/containerd.sock" # 指定容器運行時套接字

---
# ClusterConfiguration - 集群配置
apiVersion: kubeadm.k8s.io/v1beta4
kind: ClusterConfiguration

# 集群基本配置
kubernetesVersion: "v{{ kubernetes_version }}"           # Kubernetes 版本，動態從變數獲取
controlPlaneEndpoint: "{{ control_plane_endpoint }}"     # 控制平面端點，用於高可用訪問
clusterName: "{{ cluster_name }}"                         # 集群名稱

# 網路配置
networking:
  podSubnet: "{{ pod_network_cidr }}"                     # Pod 網路子網範圍
  serviceSubnet: "{{ service_cidr }}"                     # Service 網路子網範圍

# 控制器管理器配置
controllerManager:
  extraArgs:
    - name: bind-address
      value: "0.0.0.0"                                    # 綁定所有網路接口，允許遠程訪問

# 調度器配置
scheduler:
  extraArgs:
    - name: bind-address
      value: "0.0.0.0"                                    # 綁定所有網路接口，允許遠程訪問

# API 服務器配置
apiServer:
  # API Server 證書的 Subject Alternative Names
  # 包含所有可能用於訪問 API Server 的地址
  certSANs:
    - "{{ cluster_vip }}"                                 # VIP 地址
    - "k8s-api.detectviz.internal"                        # VIP 域名
    - "k8s-api"                                           # VIP 短名稱
    - "192.168.0.11"                                      # Master-1 IP
    - "192.168.0.12"                                      # Master-2 IP
    - "192.168.0.13"                                      # Master-3 IP
    - "master-1"                                          # Master-1 主機名
    - "master-2"                                          # Master-2 主機名
    - "master-3"                                          # Master-3 主機名
    - "localhost"                                         # 本地訪問
    - "127.0.0.1"                                         # 本地 IP
  extraArgs:
    - name: authorization-mode
      value: Node,RBAC                                    # 授權模式：節點授權和 RBAC
    - name: service-account-issuer
      value: https://kubernetes.default.svc.cluster.local # Service Account 發行者
    - name: service-account-signing-key-file
      value: /etc/kubernetes/pki/sa.key                   # Service Account 簽名金鑰文件
    - name: enable-admission-plugins
      value: NodeRestriction                              # 簡化准入插件，避免配置問題

---
# ============================================
# Kube-proxy 配置
# ============================================

# Kube-proxy 配置版本
apiVersion: kubeproxy.config.k8s.io/v1alpha1
kind: KubeProxyConfiguration
mode: ipvs                                                # 使用 IPVS 模式提供更好的性能和負載均衡
