# Configure /etc/hosts with cluster.internal naming
# 配置 /etc/hosts 包含 cluster.internal 域名

- name: Add cluster hosts entries to /etc/hosts (添加集群節點記錄到 /etc/hosts)
  ansible.builtin.blockinfile:
    path: /etc/hosts
    block: |
      # Detectviz Platform Hosts (Generated by Ansible)
      # 自動生成於: {{ ansible_date_time.date }} {{ ansible_date_time.time }}

      # 外部網路 (vmbr0 - 192.168.0.0/24)
      192.168.0.11 master-1.detectviz.internal master-1
      192.168.0.12 master-2.detectviz.internal master-2
      192.168.0.13 master-3.detectviz.internal master-3
      192.168.0.14 app-worker.detectviz.internal app-worker
      192.168.0.10 k8s-api.detectviz.internal k8s-api

      # 內部集群網路 (vmbr1 - 10.0.0.0/24 - Kubernetes 節點間通訊)
      10.0.0.11 master-1.cluster.internal master-1-cluster
      10.0.0.12 master-2.cluster.internal master-2-cluster
      10.0.0.13 master-3.cluster.internal master-3-cluster
      10.0.0.14 app-worker.cluster.internal app-worker-cluster
    marker: "# {mark} ANSIBLE MANAGED BLOCK - Detectviz Cluster"
    create: yes
    mode: '0644'
  become: true

- name: Verify /etc/hosts configuration (驗證 /etc/hosts 配置)
  ansible.builtin.command: "getent hosts {{ item }}"
  loop:
    - master-1.detectviz.internal
    - master-1.cluster.internal
    - app-worker.detectviz.internal
    - app-worker.cluster.internal
  register: hosts_status
  changed_when: false
  ignore_errors: true

- name: Display /etc/hosts configuration result (顯示 /etc/hosts 配置結果)
  ansible.builtin.debug:
    msg: |
      ========================================
      /etc/hosts Configuration Applied (/etc/hosts 配置已應用)
      ========================================

      Node: {{ inventory_hostname }}

      DNS Resolution Test:
      {{ hosts_status.results | map(attribute='stdout') | join('\n') }}

      ========================================
