# Configure Network Interfaces for Dual-Network Architecture
# 配置網路介面以支援雙網路架構 (vmbr0 外部網路 + vmbr1 內部集群網路)

- name: Ensure network configuration directory exists (確保網路配置目錄存在)
  ansible.builtin.file:
    path: /etc/netplan
    state: directory
  become: true

- name: Configure network interfaces with correct MTU (配置網路介面並設定正確的 MTU)
  ansible.builtin.template:
    src: network-config.yaml.j2
    dest: /etc/netplan/50-detectviz-network.yaml
    mode: "0644"
  become: true
  vars:
    network_mtu: "{{ network_mtu | default(1500) }}"

- name: Apply network configuration (應用網路配置)
  ansible.builtin.command: netplan apply
  become: true
  changed_when: false

- name: Set MTU for external network interface (設定外部網路介面 MTU - eth0)
  ansible.builtin.command: >
    ip link set eth0 mtu {{ network_mtu | default(1500) }}
  become: true
  ignore_errors: true
  changed_when: false

- name: Set MTU for internal cluster network interface (設定內部集群網路介面 MTU - eth1)
  ansible.builtin.command: >
    ip link set eth1 mtu {{ network_mtu | default(1500) }}
  become: true
  ignore_errors: true
  changed_when: false

- name: Verify external network interface status (驗證外部網路介面狀態 - eth0)
  ansible.builtin.command: ip addr show eth0
  register: network_status_external
  changed_when: false

- name: Verify internal cluster network interface status (驗證內部集群網路介面狀態 - eth1)
  ansible.builtin.command: ip addr show eth1
  register: network_status_internal
  changed_when: false

- name: Display network configuration result (顯示網路配置結果)
  ansible.builtin.debug:
    msg: |
      ========================================
      Dual-Network Configuration Applied (雙網路配置已應用)
      ========================================

      Node: {{ inventory_hostname }}
      Role: {{ 'Worker' if 'workers' in group_names else 'Master' }}

      External Network Interface (eth0 - vmbr0):
      {{ network_status_external.stdout }}

      Internal Cluster Network Interface (eth1 - vmbr1):
      {{ network_status_internal.stdout }}

      MTU: {{ network_mtu | default(1500) }}

      ========================================
