# Configure sysctl parameters for Kubernetes networking
# 配置 Kubernetes 網路所需的 sysctl 參數

- name: Configure sysctl parameters for Kubernetes (配置 Kubernetes sysctl 參數)
  ansible.builtin.copy:
    dest: /etc/sysctl.d/99-k8s-network.conf
    content: |
      # Kubernetes Node sysctl Configuration
      # 自動生成於: {{ ansible_date_time.date }} {{ ansible_date_time.time }}

      # Enable IP forwarding (啟用 IP 轉發 - CNI Overlay 必須)
      net.ipv4.ip_forward = 1

      # Bridge netfilter (允許橋接封包進入 iptables)
      net.bridge.bridge-nf-call-iptables = 1
      net.bridge.bridge-nf-call-ip6tables = 1

      # Reverse path filtering (寬鬆模式 - 支援非對稱路由)
      # 推薦值 2 for Kubernetes dual-network architecture
      net.ipv4.conf.all.rp_filter = 2
      net.ipv4.conf.default.rp_filter = 2

      # Disable IPv6 (可選 - 避免干擾)
      net.ipv6.conf.all.disable_ipv6 = 1
      net.ipv6.conf.default.disable_ipv6 = 1
    mode: '0644'
  become: true

- name: Load br_netfilter module (載入 br_netfilter 模組)
  ansible.builtin.modprobe:
    name: br_netfilter
    state: present
  become: true

- name: Ensure br_netfilter loads on boot (確保 br_netfilter 開機自動載入)
  ansible.builtin.lineinfile:
    path: /etc/modules-load.d/k8s.conf
    line: br_netfilter
    create: yes
    mode: '0644'
  become: true

- name: Apply sysctl settings (應用 sysctl 設定)
  ansible.builtin.command: sysctl --system
  become: true
  changed_when: false

- name: Verify sysctl settings (驗證 sysctl 設定)
  ansible.builtin.command: "sysctl {{ item }}"
  loop:
    - net.ipv4.ip_forward
    - net.ipv4.conf.all.rp_filter
    - net.bridge.bridge-nf-call-iptables
  register: sysctl_status
  changed_when: false

- name: Display sysctl configuration result (顯示 sysctl 配置結果)
  ansible.builtin.debug:
    msg: |
      ========================================
      Sysctl Configuration Applied (sysctl 配置已應用)
      ========================================

      Node: {{ inventory_hostname }}

      {{ sysctl_status.results | map(attribute='stdout') | join('\n') }}

      ========================================
