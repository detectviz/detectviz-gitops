---
# ============================================
# Worker 節點角色任務 - 加入集群
# ============================================

# ============================================
# LVM 配置 (為 TopoLVM 準備儲存)
# ============================================

- name: Install LVM tools if not already installed (安裝 LVM 工具 (若尚未安裝))
  ansible.builtin.apt:
    name: lvm2
    state: present
    update_cache: true
  when: configure_lvm | bool
  tags:
    - lvm

- name: Check Worker VM disk configuration (檢查 Worker VM 磁碟配置)
  ansible.builtin.shell: |
    echo "=== 磁碟設備列表 ==="
    lsblk -d -o NAME,SIZE,TYPE,MODEL
    echo ""
    echo "=== 詳細設備信息 ==="
    lsblk -o NAME,SIZE,FSTYPE,MOUNTPOINTS,LABEL
  register: disk_info
  when: configure_lvm | bool
  changed_when: false
  tags:
    - lvm

- name: Display disk configuration information (顯示磁碟配置信息)
  ansible.builtin.debug:
    msg: |
      === {{ inventory_hostname }} 磁碟配置 ===
      {{ disk_info.stdout }}
  when: configure_lvm | bool
  tags:
    - lvm

- name: Verify LVM configuration devices exist (驗證 LVM 配置設備存在)
  ansible.builtin.shell: |
    for device in {{ lvm_volume_groups | selectattr('devices', 'defined') | map(attribute='devices') | flatten | unique | join(' ') }}; do
      if [ ! -b "$device" ]; then
        echo "錯誤: 設備 $device 不存在"
        exit 1
      fi
      # 檢查設備是否已被使用
      if blkid "$device" > /dev/null 2>&1; then
        echo "警告: 設備 $device 已有檔案系統"
      fi
    done
    echo "設備檢查完成"
  register: device_check
  when: configure_lvm | bool
  changed_when: false
  tags:
    - lvm

- name: Display device check results (顯示設備檢查結果)
  ansible.builtin.debug:
    msg: "設備檢查: {{ device_check.stdout }}"
  when: configure_lvm | bool
  tags:
    - lvm

- name: Stop active LVM devices if needed (停止使用中的 LVM 設備 (如果需要))
  ansible.builtin.shell: |
    for device in {{ lvm_volume_groups | selectattr('devices', 'defined') | map(attribute='devices') | flatten | unique | join(' ') }}; do
      # 檢查設備是否已被 LVM 使用
      if pvdisplay "$device" > /dev/null 2>&1; then
        echo "設備 $device 已被 LVM 使用，跳過 pvcreate"
      else
        echo "設備 $device 可供 LVM 使用"
      fi
    done
  register: lvm_check
  when: configure_lvm | bool
  changed_when: false
  tags:
    - lvm

- name: Create physical volumes for LVM Volume Groups (為 LVM Volume Groups 創建物理卷)
  ansible.builtin.command: "pvcreate --force --yes {{ item }}"
  loop: "{{ lvm_volume_groups | selectattr('devices', 'defined') | map(attribute='devices') | flatten | unique }}"
  when: configure_lvm | bool
  ignore_errors: true # 允許 PV 已存在的錯誤
  register: pv_create_result
  tags:
    - lvm

- name: Display PV creation results (顯示 PV 創建結果)
  ansible.builtin.debug:
    msg: "PV 創建結果: {{ item.item }} - {{ item.rc == 0 | ternary('成功', '跳過(已存在)') }}"
  loop: "{{ pv_create_result.results | default([]) }}"
  when: configure_lvm | bool
  tags:
    - lvm

- name: Create LVM Volume Groups (創建 LVM Volume Groups)
  ansible.builtin.command: "vgcreate {{ item.name }} {{ item.devices | join(' ') }}"
  loop: "{{ lvm_volume_groups }}"
  when: configure_lvm | bool
  ignore_errors: true # 允許 VG 已存在的錯誤
  register: vg_create_result
  tags:
    - lvm

- name: Display VG creation results (顯示 VG 創建結果)
  ansible.builtin.debug:
    msg: "VG 創建結果: {{ item.item.name }} - {{ item.rc == 0 | ternary('成功', '跳過(已存在)') }}"
  loop: "{{ vg_create_result.results | default([]) }}"
  when: configure_lvm | bool
  tags:
    - lvm

- name: Verify LVM Volume Groups (驗證 LVM Volume Groups)
  ansible.builtin.command: vgs --units g --noheadings -o vg_name,vg_size,vg_free
  register: vgs_output
  when: configure_lvm | bool
  changed_when: false
  tags:
    - lvm

- name: Verify LVM Physical Volumes (驗證 LVM Physical Volumes)
  ansible.builtin.command: pvs --units g --noheadings -o pv_name,pv_size,pv_free,vg_name
  register: pvs_output
  when: configure_lvm | bool
  changed_when: false
  tags:
    - lvm

- name: Display LVM configuration results (顯示 LVM 配置結果)
  ansible.builtin.debug:
    msg: |
      === {{ inventory_hostname }} LVM 配置完成 ===

      Volume Groups:
      {{ vgs_output.stdout_lines | join('\n') | default('無 VG') }}

      Physical Volumes:
      {{ pvs_output.stdout_lines | join('\n') | default('無 PV') }}

      配置的 VG: {{ lvm_volume_groups | map(attribute='name') | join(', ') }}
  when: configure_lvm | bool
  tags:
    - lvm

# ============================================
# Kubernetes 集群加入
# ============================================

# 檢查節點是否已經加入集群（初步檢查）
- name: Check if node is already joined to cluster (preliminary check) (檢查節點是否已加入集群（初步檢查）)
  ansible.builtin.stat:
    path: /etc/kubernetes/kubelet.conf
  register: kubelet_conf_initial

# 強制重置（如請求且已加入）
- name: Force reset node if needed and already joined (強制重置節點（如需要且已加入）)
  ansible.builtin.command: kubeadm reset --force
  when:
    - force_rejoin | bool
    - kubelet_conf_initial.stat.exists
  ignore_errors: true
  tags:
    - reset

# 確保 containerd 重新啟動（kubeadm reset 會停止它）
- name: Ensure containerd runs normally after reset (確保 containerd 在重置後正常運行)
  ansible.builtin.systemd:
    name: containerd
    state: started
    enabled: true
  when: force_rejoin | bool

# 清理配置用於強制重新加入
- name: Clean up configuration for forced rejoin (清理配置以進行強制重新加入)
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - /etc/kubernetes
    - /var/lib/kubelet
    - /etc/cni/net.d
  when:
    - force_rejoin | bool
    - kubelet_conf_initial.stat.exists
  ignore_errors: true
  tags:
    - reset

# 最終檢查節點狀態（在所有清理操作後）
- name: Final check node status (after all cleanup operations) (最終檢查節點狀態（所有清理操作完成後）)
  ansible.builtin.stat:
    path: /etc/kubernetes/kubelet.conf
  register: kubelet_conf_final

# 等待 API server 就緒
- name: Wait for API Server to be ready (等待 API Server 就緒)
  ansible.builtin.uri:
    url: "https://{{ control_plane_endpoint }}/healthz"
    validate_certs: false
    timeout: 10
  register: api_health
  until: api_health.status == 200
  retries: 30
  delay: 10
  when: not kubelet_conf_final.stat.exists
  ignore_errors: true

# 確保 containerd 運行正常
- name: 確保 containerd 在加入前正常運行
  ansible.builtin.systemd:
    name: containerd
    state: started
  when: not kubelet_conf_final.stat.exists

# 確保 kubelet 在加入前停止
- name: 確保 kubelet 在加入前已停止
  ansible.builtin.systemd:
    name: kubelet
    state: stopped
  when: not kubelet_conf_final.stat.exists
  ignore_errors: true

# 強制終止任何剩餘的 Kubernetes 進程
- name: 終止所有剩餘的 Kubernetes 進程
  ansible.builtin.shell: |
    for proc in kubelet kube-proxy; do
      pkill -9 -x "$proc" 2>/dev/null || true
    done
  when: not kubelet_conf_final.stat.exists
  ignore_errors: true

# 等待服務完全停止
- name: 等待服務完全停止
  ansible.builtin.pause:
    seconds: 3
  when: not kubelet_conf_final.stat.exists

# 將 Worker 節點加入集群
- name: 將 Worker 節點加入集群
  ansible.builtin.command: "{{ worker_join_command }} --node-name {{ inventory_hostname }}"
  when:
    - worker_join_command is defined
    - not kubelet_conf_final.stat.exists
  register: join_worker
  changed_when: join_worker.rc == 0
  failed_when: join_worker.rc != 0
  retries: 3
  delay: 10
  until: join_worker.rc == 0

# 等待 kubelet 啟動並穩定
- name: 等待 kubelet 啟動並進入健康狀態
  ansible.builtin.uri:
    url: "http://127.0.0.1:10248/healthz"
    timeout: 5
  register: kubelet_health
  until: kubelet_health.status == 200
  retries: 30
  delay: 5
  when: join_worker is changed
  ignore_errors: true
