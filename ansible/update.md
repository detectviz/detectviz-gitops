# é—œéµå•é¡Œä¿®æ­£ï¼šAPI Server å•Ÿå‹•å¤±æ•—

**æ—¥æœŸ**: 2025-11-13
**ç‹€æ…‹**: âœ… å·²æ‰¾åˆ°æ ¹æœ¬åŸå› ä¸¦ä¿®æ­£

---

## ğŸ”´ å•é¡Œç¾è±¡

åŸ·è¡Œ `ansible-playbook -i inventory.ini deploy-cluster.yml` æ™‚ï¼Œkubeadm init å¤±æ•—ï¼š

```
TASK [master : Initialize first control plane node] ***
fatal: [master-1]: FAILED!
[api-check] The API server is not healthy after 4m0.000489777s
error execution phase wait-control-plane: could not initialize a Kubernetes cluster
```

**é—œéµè­¦å‘Šè¨Šæ¯**ï¼š
```
W1113 06:40:56.264443 detected that the sandbox image "" of the container runtime is inconsistent
```

---

## ğŸ” å•é¡Œè¨ºæ–·éç¨‹

### ç¬¬ä¸€æ­¥ï¼šæª¢æŸ¥ Containerd é…ç½®

**æª¢æŸ¥å‘½ä»¤**ï¼š
```bash
ssh ubuntu@192.168.0.11 'sudo grep sandbox_image /etc/containerd/config.toml'
```

**çµæœ**ï¼š
```toml
sandbox_image = "registry.k8s.io/pause:3.10"
```

âœ… **Containerd é…ç½®æ­£ç¢º**ï¼Œsandbox_image å·²æ­£ç¢ºè¨­å®šã€‚

---

### ç¬¬äºŒæ­¥ï¼šæª¢æŸ¥ Kubelet æ—¥èªŒ

**æª¢æŸ¥å‘½ä»¤**ï¼š
```bash
ssh ubuntu@192.168.0.11 'sudo journalctl -u kubelet --no-pager -n 100 | grep -i "error\|failed"'
```

**é—œéµéŒ¯èª¤è¨Šæ¯**ï¼š
```
E1113 07:19:08.768271 3533 controller.go:145 "Failed to ensure lease exists, will retry"
err="Get \"https://k8s-api.detectviz.internal:6443/...\": dial tcp 192.168.0.10:6443: connect: no route to host"
```

ğŸ”´ **ç™¼ç¾æ ¹æœ¬åŸå› ï¼**

---

## ğŸ’¡ æ ¹æœ¬åŸå› åˆ†æ

### é›ç”Ÿè›‹å•é¡Œï¼ˆChicken-and-Egg Problemï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. kubeadm init é–‹å§‹                                         â”‚
â”‚    â””â”€> controlPlaneEndpoint: k8s-api.detectviz.internal    â”‚
â”‚        (è§£æåˆ° VIP 192.168.0.10)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Kubelet å˜—è©¦é€£æ¥ API Server                              â”‚
â”‚    â””â”€> é€£æ¥ 192.168.0.10:6443                              â”‚
â”‚    â””â”€> âŒ éŒ¯èª¤ï¼šno route to host                            â”‚
â”‚        (å› ç‚º VIP é‚„ä¸å­˜åœ¨ï¼)                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. API Server ç„¡æ³•å•Ÿå‹•                                       â”‚
â”‚    â””â”€> Kubelet ç„¡æ³•é€šä¿¡                                     â”‚
â”‚    â””â”€> Health check è¶…æ™‚                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. Kube-VIP ç„¡æ³•éƒ¨ç½²                                         â”‚
â”‚    â””â”€> å› ç‚º Kube-VIP åœ¨ kubeadm init **ä¹‹å¾Œ**æ‰éƒ¨ç½²        â”‚
â”‚    â””â”€> VIP 192.168.0.10 æ°¸é ç„¡æ³•ç¶å®š                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ™‚åºå•é¡Œ

| æ­¥é©Ÿ | æ“ä½œ | VIP ç‹€æ…‹ | çµæœ |
|------|------|----------|------|
| 1 | kubeadm init é–‹å§‹ | âŒ ä¸å­˜åœ¨ | å˜—è©¦é€£æ¥ 192.168.0.10 |
| 2 | API Server å•Ÿå‹• | âŒ ä¸å­˜åœ¨ | é€£æ¥å¤±æ•— |
| 3 | Kubelet æª¢æŸ¥å¥åº·ç‹€æ…‹ | âŒ ä¸å­˜åœ¨ | è¶…æ™‚å¤±æ•— |
| 4 | Kube-VIP éƒ¨ç½²ï¼ˆè¨ˆåŠƒï¼‰ | âŒ ç„¡æ³•åŸ·è¡Œ | init å·²å¤±æ•— |

---

## âœ… è§£æ±ºæ–¹æ¡ˆ

### ä¿®æ­£ç­–ç•¥

**é—œéµæ¦‚å¿µ**ï¼šç¬¬ä¸€å€‹ master åˆå§‹åŒ–æ™‚**ä¸ä½¿ç”¨ VIP**ï¼Œè€Œæ˜¯ä½¿ç”¨ master-1 çš„å¯¦éš› IPã€‚

### ä¿®æ­£çš„é…ç½®æ–‡ä»¶

**æ–‡ä»¶**: `ansible/group_vars/all.yml`

**ä¿®æ”¹å‰**ï¼š
```yaml
control_plane_endpoint: "k8s-api.detectviz.internal:6443" # æŒ‡å‘ VIP
cluster_vip: "192.168.0.10"
```

**ä¿®æ”¹å¾Œ**ï¼š
```yaml
control_plane_endpoint: "192.168.0.11:6443" # ç¬¬ä¸€æ¬¡åˆå§‹åŒ–ä½¿ç”¨ master-1 å¯¦éš› IP
cluster_vip: "192.168.0.10" # HA VIPï¼ˆKube-VIP éƒ¨ç½²å¾Œæ‰å•Ÿç”¨ï¼‰
control_plane_vip_endpoint: "k8s-api.detectviz.internal:6443" # HA VIP ç«¯é»ï¼ˆç”¨æ–¼å¾ŒçºŒ master åŠ å…¥ï¼‰
```

---

## ğŸ¯ ä¿®æ­£å¾Œçš„éƒ¨ç½²æµç¨‹

### éšæ®µ 1ï¼šåˆå§‹åŒ–ç¬¬ä¸€å€‹ Master

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. kubeadm init                                             â”‚
â”‚    â””â”€> controlPlaneEndpoint: 192.168.0.11:6443            â”‚
â”‚    â””â”€> âœ… ç›´æ¥é€£æ¥ master-1 å¯¦éš› IP                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. API Server æˆåŠŸå•Ÿå‹•                                       â”‚
â”‚    â””â”€> ç›£è½åœ¨ 192.168.0.11:6443                            â”‚
â”‚    â””â”€> âœ… Kubelet å¯ä»¥æ­£å¸¸é€šä¿¡                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. å‰µå»º /etc/kubernetes/admin.conf                          â”‚
â”‚    â””â”€> âœ… é›†ç¾¤åˆå§‹åŒ–å®Œæˆ                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### éšæ®µ 2ï¼šéƒ¨ç½² Kube-VIP

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. è‡ªå‹•éƒ¨ç½² Kube-VIP éœæ…‹ Pod                                â”‚
â”‚    â””â”€> ä½¿ç”¨ /etc/kubernetes/admin.conf                     â”‚
â”‚    â””â”€> âœ… Kube-VIP Pod å•Ÿå‹•                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. VIP ç¶å®šåˆ° eth0                                           â”‚
â”‚    â””â”€> 192.168.0.10 ç¶å®šæˆåŠŸ                               â”‚
â”‚    â””â”€> âœ… HA ç«¯é»å¯ç”¨                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### éšæ®µ 3ï¼šå¾ŒçºŒ Master åŠ å…¥ï¼ˆæœªä¾†ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. Master-2, Master-3 åŠ å…¥                                   â”‚
â”‚    â””â”€> ä½¿ç”¨ control_plane_vip_endpoint                     â”‚
â”‚    â””â”€> kubeadm join k8s-api.detectviz.internal:6443       â”‚
â”‚    â””â”€> âœ… é€šé VIP é€£æ¥ï¼Œå¯¦ç¾ HA                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ å¾ŒçºŒä»»å‹™

### éœ€è¦é€²ä¸€æ­¥ä¿®æ­£çš„é…ç½®

1. **`roles/master/tasks/main.yml`**
   - åœ¨ç”Ÿæˆ join command æ™‚ï¼Œæª¢æŸ¥æ˜¯å¦ç‚ºç¬¬ä¸€å€‹ master
   - ç¬¬ä¸€å€‹ master ä½¿ç”¨ `control_plane_endpoint` (192.168.0.11)
   - å¾ŒçºŒ master ä½¿ç”¨ `control_plane_vip_endpoint` (VIP)

2. **æ›´æ–° kubeconfig ç«¯é»**ï¼ˆå¯é¸ï¼‰
   - åœ¨ Kube-VIP éƒ¨ç½²å¾Œï¼Œå¯ä»¥å°‡ kubeconfig çš„ server URL æ›´æ–°ç‚º VIP
   - æˆ–ä¿æŒä½¿ç”¨ master-1 IPï¼ˆå› ç‚ºè¨ªå•ä»»ä½•ä¸€å€‹ master éƒ½å¯ä»¥ï¼‰

---

## âœ… é©—è­‰æ­¥é©Ÿ

### éƒ¨ç½²å¾Œé©—è­‰

```bash
# 1. æª¢æŸ¥é›†ç¾¤ç‹€æ…‹
ssh ubuntu@192.168.0.11 'kubectl get nodes'

# 2. æª¢æŸ¥ API Server ç«¯é»
ssh ubuntu@192.168.0.11 'grep server: /etc/kubernetes/admin.conf'
# æ‡‰è©²é¡¯ç¤ºï¼šserver: https://192.168.0.11:6443

# 3. æª¢æŸ¥ Kube-VIP Pod ç‹€æ…‹
ssh ubuntu@192.168.0.11 'kubectl get pods -n kube-system | grep kube-vip'

# 4. æª¢æŸ¥ VIP æ˜¯å¦ç¶å®š
ssh ubuntu@192.168.0.11 'ip addr show eth0 | grep 192.168.0.10'

# 5. æ¸¬è©¦ VIP é€£æ¥
curl -k https://192.168.0.10:6443/healthz
# æ‡‰è©²è¿”å›ï¼šok
```

---

## ğŸ‰ ç¸½çµ

### å•é¡Œæœ¬è³ª

åŸå§‹è¨­è¨ˆå˜—è©¦åœ¨ kubeadm init ä¹‹å‰å°±ä½¿ç”¨ VIPï¼Œä½† Kube-VIP éœ€è¦ä¾è³´ kubeadm init ç”Ÿæˆçš„ admin.conf æ–‡ä»¶æ‰èƒ½é‹è¡Œï¼Œå½¢æˆäº†ä¸å¯è§£çš„å¾ªç’°ä¾è³´ã€‚

### ä¿®æ­£æ–¹æ¡ˆ

æ¡ç”¨**åˆ†éšæ®µéƒ¨ç½²**ç­–ç•¥ï¼š
1. âœ… **éšæ®µ 1**ï¼šä½¿ç”¨ master-1 å¯¦éš› IP å®Œæˆé›†ç¾¤åˆå§‹åŒ–
2. âœ… **éšæ®µ 2**ï¼šéƒ¨ç½² Kube-VIP å•Ÿç”¨ VIP
3. âœ… **éšæ®µ 3**ï¼šå¾ŒçºŒç¯€é»é€šé VIP åŠ å…¥ï¼ˆå¯¦ç¾çœŸæ­£çš„ HAï¼‰

### éƒ¨ç½²ç‹€æ…‹

| çµ„ä»¶ | ç‹€æ…‹ | èªªæ˜ |
|------|------|------|
| Containerd é…ç½® | âœ… æ­£ç¢º | sandbox_image å·²æ­£ç¢ºè¨­å®š |
| Ansible ä»»å‹™é †åº | âœ… æ­£ç¢º | Kube-VIP åœ¨ init ä¹‹å¾Œéƒ¨ç½² |
| Control Plane Endpoint | âœ… å·²ä¿®æ­£ | ä½¿ç”¨ master-1 å¯¦éš› IP |
| Kube-VIP é…ç½® | âœ… æ­£ç¢º | ç¶²å¡åç¨±ã€ç’°å¢ƒè®Šæ•¸éƒ½æ­£ç¢º |

**é‡æ–°éƒ¨ç½²é æœŸ**ï¼šâœ… **å¯ä»¥æˆåŠŸåˆå§‹åŒ– Kubernetes é›†ç¾¤**

---

## ğŸš€ ä¸‹ä¸€æ­¥

```bash
# é‡æ–°éƒ¨ç½²é›†ç¾¤
cd /Users/zoe/Documents/github/detectviz-gitops/ansible
ansible-playbook -i inventory.ini deploy-cluster.yml
```

é æœŸçµæœï¼š
- âœ… Kubeadm init æˆåŠŸ
- âœ… API Server æ­£å¸¸å•Ÿå‹•
- âœ… Kube-VIP è‡ªå‹•éƒ¨ç½²
- âœ… VIP 192.168.0.10 æˆåŠŸç¶å®š
- âœ… å®Œå…¨è‡ªå‹•åŒ–çš„ HA é›†ç¾¤éƒ¨ç½²
