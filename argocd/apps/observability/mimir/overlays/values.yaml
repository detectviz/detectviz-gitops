# Mimir Configuration (Base Defaults + Production Overrides)
# 檔案前段保留共用設定，後段追加 production 環境覆寫。

# 副本數 (由 環境覆寫 覆寫)
replicas: 1

# MinIO (不使用,改用 filesystem backend)
minio:
  enabled: false

# Mimir 核心配置
mimir:
  structuredConfig:
    # 禁用認證 (內部 Prometheus → Mimir 流量)
    auth_enabled: false

    # 使用 filesystem backend (適合本地部署)
    blocks_storage:
      backend: filesystem
      filesystem:
        dir: /data/mimir/blocks

    # Memberlist 配置
    memberlist:
      join_members:
        - mimir-gossip-ring.monitoring.svc.cluster.local

# Alertmanager (Mimir 內建)
alertmanager:
  replicas: 1
  persistentVolume:
    enabled: false

# Ingester (寫入路徑)
ingester:
  replicas: 1
  persistentVolume:
    enabled: false

# Store Gateway (查詢路徑)
store_gateway:
  replicas: 1
  persistentVolume:
    enabled: false

# Compactor (壓縮與刪除)
compactor:
  replicas: 1
  persistentVolume:
    enabled: false

# Distributor (接收 Remote Write)
distributor:
  replicas: 1

# Querier (查詢執行)
querier:
  replicas: 1

# Query Frontend (查詢入口)
query_frontend:
  replicas: 1

# 元監控 (監控 Mimir 自身)
metaMonitoring:
  serviceMonitor:
    enabled: true
  prometheusRule:
    enabled: false  # Environment Overrides 啟用
# --- Production Overrides ---
# Mimir 生產環境配置 (Production Environment Overrides)
#
# 本文件為 Grafana Mimir 在生產環境的 Helm Chart Values，使用 'mimir-distributed' chart 來實現一個
# 高可用、可擴展且與平台深度整合的長期指標儲存系統 (TSDB)。
#
# 參考文件:
# - 本平台指南: gitops-argocd/guide/mimir.md
# - Helm Chart 官方文檔: https://github.com/grafana/helm-charts/tree/main/charts/mimir-distributed

# 禁用內建的 MinIO，因為我們將使用基於 PVC 的 filesystem backend。
minio:
  enabled: false

# --- Mimir 核心配置 ---
mimir:
  structuredConfig:
    # 禁用認證，由 NetworkPolicy 和 Gateway 進行訪問控制。
    # 來自內部 Prometheus 的 remote-write 流量被視為可信。
    auth_enabled: false

    # **[關鍵]** 使用 filesystem 作為後端儲存。
    # 參考: guide/mimir.md#1.3-儲存
    blocks_storage:
      backend: filesystem
      filesystem:
        dir: /data/mimir/blocks

    # **[關鍵]** 使用 memberlist (gossip 協議) 進行服務發現，這是 HA 的基礎。
    # 參考: guide/mimir.md#1.2-高可用性
    memberlist:
      join_members:
        - mimir-gossip-ring.monitoring.svc.cluster.local

# --- 元件配置 (Component Configuration) ---
# **[關鍵]** 將所有關鍵元件的副本數設為 2，以實現高可用。
# 參考: guide/mimir.md#1.2-高可用性

# Alertmanager (Mimir 內建，用於多租戶告警)
alertmanager:
  replicas: 2
  persistentVolume:
    enabled: true
    storageClass: detectviz-sata # 使用大容量 SATA 儲存。
    size: 10Gi

# Ingester (負責接收與寫入指標數據)
ingester:
  replicas: 2
  # **[關鍵]** Ingester 需要持久化儲存來保存 WAL (Write Ahead Log)，防止數據丟失。
  persistentVolume:
    enabled: true
    storageClass: detectviz-sata
    size: 20Gi
  resources:
    requests:
      cpu: 200m
      memory: 512Mi
    limits:
      cpu: 1000m
      memory: 2Gi

# Store Gateway (負責從長期儲存中讀取舊數據)
store_gateway:
  replicas: 2
  persistentVolume:
    enabled: true
    storageClass: detectviz-sata
    size: 20Gi
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 1Gi

# Compactor (負責壓縮與合併 TSDB blocks，優化儲存與查詢)
compactor:
  replicas: 2 # 提升為 2 以符合 HA 指導原則。
  persistentVolume:
    enabled: true
    storageClass: detectviz-sata
    size: 20Gi
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 1Gi

# Distributor (接收 Prometheus remote-write 流量的入口)
distributor:
  replicas: 2
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi

# Querier (執行 PromQL 查詢)
querier:
  replicas: 2
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 1Gi

# Query Frontend (查詢隊列與快取)
query_frontend:
  replicas: 2
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi

# --- 可觀測性 (Observability) ---
# **[關鍵]** 啟用 ServiceMonitor，讓 Prometheus 可以抓取 Mimir 自身的指標。
# 參考: guide/mimir.md#2.3-可觀測性
metaMonitoring:
  serviceMonitor:
    enabled: true
    namespace: monitoring
    labels:
      prometheus: kube-prometheus-stack # 確保被正確的 Prometheus 實例選中。
      environment: production
  # 啟用 Mimir 內建的告警規則。
  prometheusRule:
    enabled: true
    mimirRules: true
    mimirAlerts: true
