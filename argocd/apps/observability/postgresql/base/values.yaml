# PostgreSQL HA 生產環境預設值
# - 本檔案提供所有環境共用的密碼、init scripts 與 HA 預設值
# - 測試環境若需降規，請使用 overlays/test/values.test.yaml（勿直接修改本檔案）

fullnameOverride: postgresql

# --- 全域密碼 Secret 設定 ---
global:
  postgresql:
    # Secret 應包含: postgres-password, password, repmgr-password
    existingSecret: detectviz-postgresql-admin
  pgpool:
    existingSecret: detectviz-postgresql-admin

# --- Pgpool-II (連線池與負載均衡) ---
pgpool:
  # image.tag 依 Helm Chart 12.8.2 預設（docker.io/bitnami/pgpool:4.6.3-debian-12-r0），嚴禁覆寫 latest 以免產生版本漂移
  replicaCount: 2          # 兩個副本確保連線池層 HA
  podAntiAffinityPreset: hard
  customUsersSecret: detectviz-pgpool-users
  persistence:
    enabled: true
    storageClass: topolvm-provisioner  # TopoLVM 提供 SSD 儲存
    size: 1Gi
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi

# --- PostgreSQL (資料庫核心) ---
postgresql:
  replicaCount: 3          # 1 primary + 2 standby，符合 README / SOP
  podAntiAffinityPreset: hard
  volumePermissions:
    enabled: true
  persistence:
    enabled: true
    storageClass: topolvm-provisioner
    size: 10Gi
  initdbScriptsSecret: detectviz-postgresql-initdb

# --- 可觀測性 (Prometheus 指標) ---
metrics:
  enabled: true
  serviceMonitor:
    enabled: true
    namespace: monitoring
    interval: 30s
    additionalLabels:
      app.kubernetes.io/part-of: detectviz-platform
      app.kubernetes.io/managed-by: bitnami-postgresql-ha
      prometheus: kube-prometheus-stack
      environment: production
    relabelings:
      - sourceLabels: [__meta_kubernetes_namespace]
        targetLabel: namespace
      - sourceLabels: [__meta_kubernetes_pod_name]
        targetLabel: pod
      - sourceLabels: [__meta_kubernetes_pod_node_name]
        targetLabel: node
